<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>Laga Host: Modern Console</title>
    
    <!-- EXTERNAL LIBRARIES -->
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Tailwind CSS (Utility First) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons (Modern SVG Icons) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- PrismJS (Syntax Highlighting for Editor) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    
    <!-- FONTS: Inter (Clean, Modern, Minimalist) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- TAILWIND CONFIGURATION -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        // Modern Palette
                        background: '#0f172a', // Slate 900
                        surface: '#1e293b',    // Slate 800
                        primary: '#6366f1',    // Indigo 500
                        primaryHover: '#4f46e5',
                        accent: '#8b5cf6',     // Violet 500
                        success: '#10b981',    // Emerald 500
                        danger: '#ef4444',     // Red 500
                        glass: 'rgba(255, 255, 255, 0.08)',
                        glassBorder: 'rgba(255, 255, 255, 0.1)',
                        textMain: '#f8fafc',
                        textMuted: '#94a3b8'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards',
                        'scale-in': 'scaleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards',
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        scaleIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- CUSTOM CSS (MODERN GLASSMORPHISM) -->
    <style>
        /* ---------------------------------------------------- */
        /* GLOBAL RESET & BASE STYLES */
        /* ---------------------------------------------------- */
        :root {
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            --backdrop-blur: 16px;
        }

        body {
            background-color: #020617; /* Very Dark Slate */
            background-image: 
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(139, 92, 246, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(16, 185, 129, 0.05) 0px, transparent 50%);
            background-attachment: fixed;
            color: #f1f5f9;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* ---------------------------------------------------- */
        /* GLASSMORPHISM CARD COMPONENT */
        /* ---------------------------------------------------- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--backdrop-blur));
            -webkit-backdrop-filter: blur(var(--backdrop-blur));
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .glass-panel:hover {
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 12px 40px -8px rgba(99, 102, 241, 0.2);
        }

        /* ---------------------------------------------------- */
        /* MODERN INPUT FIELDS */
        /* ---------------------------------------------------- */
        .modern-input {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
            width: 100%;
        }

        .modern-input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            outline: none;
            background: rgba(15, 23, 42, 0.8);
        }

        .modern-input::placeholder {
            color: #64748b;
        }

        /* ---------------------------------------------------- */
        /* MODERN BUTTONS */
        /* ---------------------------------------------------- */
        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            font-weight: 600;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-primary::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(255,255,255,0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }
        
        .btn-primary:hover::after { opacity: 1; }
        .btn-primary:active { transform: scale(0.98); }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
            font-weight: 500;
            border-radius: 12px;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* ---------------------------------------------------- */
        /* SCROLLBAR & UTILS */
        /* ---------------------------------------------------- */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(99, 102, 241, 0.3); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(99, 102, 241, 0.6); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* ---------------------------------------------------- */
        /* ANIMATED LOADER (Minimalist Spinner) */
        /* ---------------------------------------------------- */
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(99, 102, 241, 0.3);
            border-radius: 50%;
            border-top-color: #6366f1;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ---------------------------------------------------- */
        /* TOAST NOTIFICATIONS */
        /* ---------------------------------------------------- */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            display: flex;
            flex-col-gap: 10px;
            pointer-events: none;
            width: 90%;
            max-width: 400px;
        }
        
        .toast {
            pointer-events: auto;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: slideDown 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* ---------------------------------------------------- */
        /* SYNTAX HIGHLIGHTING OVERRIDES */
        /* ---------------------------------------------------- */
        code[class*="language-"], pre[class*="language-"] {
            font-family: 'JetBrains Mono', monospace !important;
            font-size: 13px !important;
            text-shadow: none !important;
            border-radius: 8px;
        }
    </style>
</head>
<body class="selection:bg-primary selection:text-white">

    <!-- BACKGROUND GRADIENT BLUR SPOTS -->
    <div class="fixed top-[-10%] left-[-10%] w-[40%] h-[40%] bg-primary/20 rounded-full blur-[100px] pointer-events-none z-[-1]"></div>
    <div class="fixed bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-accent/20 rounded-full blur-[100px] pointer-events-none z-[-1]"></div>

    <!-- TOAST CONTAINER -->
    <div id="toast-container" class="toast-container flex flex-col items-center gap-2"></div>

    <!-- =========================================================================================== -->
    <!-- 1. SYSTEM BOOT LOADER (MODERN MINIMALIST) -->
    <!-- =========================================================================================== -->
    <div id="loader" class="fixed inset-0 z-[5000] bg-[#020617] flex flex-col items-center justify-center transition-opacity duration-700">
        <div class="relative">
            <div class="spinner"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <div class="w-2 h-2 bg-primary rounded-full animate-pulse"></div>
            </div>
        </div>
        <div class="mt-6 text-textMuted font-medium tracking-widest text-sm">INITIALIZING...</div>
    </div>

    <!-- =========================================================================================== -->
    <!-- 2. MAIN DASHBOARD INTERFACE -->
    <!-- =========================================================================================== -->
    <main id="app" class="hidden opacity-0 px-4 py-8 max-w-lg mx-auto relative z-10 transition-opacity duration-700">
        
        <!-- HEADER SECTION -->
        <header class="flex justify-between items-center mb-8 animate-slide-up" style="animation-delay: 0.1s;">
            <div class="flex items-center gap-4">
                <!-- User Avatar -->
                <div class="relative group cursor-pointer">
                    <img id="userAvatar" src="" class="w-12 h-12 rounded-full border-2 border-glassBorder object-cover shadow-lg group-hover:scale-105 transition duration-300">
                    <div class="absolute bottom-0 right-0 w-3 h-3 bg-success rounded-full border-2 border-[#020617]"></div>
                </div>
                
                <!-- User Details -->
                <div>
                    <h1 class="text-white font-bold text-lg leading-tight">Dashboard</h1>
                    <div class="text-textMuted text-xs font-medium mt-0.5">
                        <span id="userName">User</span>
                    </div>
                </div>
            </div>

            <!-- Plan Badge -->
            <div id="planBadge" class="px-3 py-1.5 rounded-full bg-glass border border-glassBorder text-xs font-semibold text-primary backdrop-blur-md">
                FREE
            </div>
        </header>

        <!-- DASHBOARD STATS GRID -->
        <div class="grid grid-cols-2 gap-4 mb-8 animate-slide-up" style="animation-delay: 0.2s;">
            <!-- Points Card -->
            <div class="glass-panel p-5 relative group">
                <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition">
                    <i data-lucide="zap" class="w-12 h-12 text-white"></i>
                </div>
                <div class="text-textMuted text-xs font-medium mb-1">Total Credits</div>
                <div id="refCount" class="text-3xl font-bold text-white mb-3">0</div>
                <button onclick="copyLink()" class="flex items-center gap-2 text-xs font-semibold text-primary hover:text-primaryHover transition">
                    <i data-lucide="share-2" class="w-3 h-3"></i> Invite Friend
                </button>
            </div>
            
            <!-- Server Load Card -->
            <div class="glass-panel p-5 relative">
                <div class="text-textMuted text-xs font-medium mb-1">Server Slots</div>
                <div class="flex items-end gap-2 mb-3">
                    <span id="limitBadge" class="text-3xl font-bold text-white">0/1</span>
                    <span class="text-xs text-textMuted mb-1.5">Active</span>
                </div>
                
                <!-- Animated Progress Bar -->
                <div class="w-full h-1.5 bg-gray-800 rounded-full overflow-hidden">
                    <div class="h-full bg-gradient-to-r from-primary to-accent w-1/2 animate-pulse rounded-full"></div>
                </div>
            </div>
        </div>

        <!-- MAIN ACTION BUTTON -->
        <button onclick="openModal('createModal')" class="w-full btn-primary py-4 mb-8 flex items-center justify-center gap-3 animate-slide-up" style="animation-delay: 0.3s;">
            <i data-lucide="plus-circle" class="w-5 h-5"></i> 
            <span class="text-sm tracking-wide">DEPLOY NEW BOT</span>
        </button>

        <!-- SERVER LIST CONTAINER -->
        <div class="mb-10 animate-slide-up" style="animation-delay: 0.4s;">
            <div class="flex items-center justify-between mb-4 px-1">
                <h3 class="text-sm font-semibold text-textMuted uppercase tracking-wider">Active Instances</h3>
                <i data-lucide="server" class="w-4 h-4 text-textMuted"></i>
            </div>
            
            <div id="botsContainer" class="space-y-4 min-h-[100px]">
                <!-- Dynamic Content Will Be Injected Here -->
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden glass-panel p-8 text-center border-dashed border-gray-700 opacity-70">
                <div class="w-12 h-12 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i data-lucide="box" class="w-6 h-6 text-gray-500"></i>
                </div>
                <p class="text-sm text-textMuted">No bots deployed yet.</p>
            </div>
        </div>

        <!-- UPGRADE PLANS SECTION -->
        <div class="pt-2 pb-6 animate-slide-up" style="animation-delay: 0.5s;">
            <div class="flex items-center gap-2 mb-4 px-1">
                <i data-lucide="trending-up" class="w-4 h-4 text-primary"></i>
                <h3 class="text-sm font-semibold text-textMuted uppercase tracking-wider">Upgrade Power</h3>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <!-- Pro Plan -->
                <div onclick="openPay('Pro', 50)" class="glass-panel p-4 cursor-pointer hover:border-primary/50 group relative">
                    <div class="absolute top-3 right-3"><i data-lucide="cpu" class="w-4 h-4 text-primary group-hover:scale-110 transition"></i></div>
                    <div class="text-white font-bold text-lg mb-1">Pro Core</div>
                    <div class="text-[10px] text-textMuted mb-2">5 Slots ‚Ä¢ Priority CPU</div>
                    <div class="text-xl font-bold text-primary">50‡ß≥</div>
                </div>
                <!-- VIP Plan -->
                <div onclick="openPay('VIP', 80)" class="glass-panel p-4 cursor-pointer hover:border-accent/50 group relative">
                    <div class="absolute top-3 right-3"><i data-lucide="crown" class="w-4 h-4 text-accent group-hover:scale-110 transition"></i></div>
                    <div class="text-white font-bold text-lg mb-1">VIP Core</div>
                    <div class="text-[10px] text-textMuted mb-2">10 Slots ‚Ä¢ Max Power</div>
                    <div class="text-xl font-bold text-accent">80‡ß≥</div>
                </div>
            </div>
        </div>
    </main>

    <!-- =========================================================================================== -->
    <!-- 3. INTERACTIVE MODALS (GLASS & BLUR STYLE) -->
    <!-- =========================================================================================== -->

    <!-- [A] CREATE BOT MODAL -->
    <div id="createModal" class="fixed inset-0 z-[2000] hidden">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal('createModal')"></div>
        <!-- Modal Content -->
        <div class="absolute bottom-0 left-0 right-0 md:top-1/2 md:bottom-auto md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 w-full max-w-md bg-[#0f172a] md:rounded-2xl rounded-t-2xl border-t md:border border-glassBorder p-6 shadow-2xl transform transition-transform duration-300 translate-y-full animate-slide-up">
            <div class="w-12 h-1 bg-gray-700 rounded-full mx-auto mb-6 md:hidden"></div>
            
            <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-primary/20 flex items-center justify-center">
                    <i data-lucide="terminal-square" class="w-5 h-5 text-primary"></i>
                </div>
                Deploy New Instance
            </h2>
            
            <div class="space-y-5">
                <div>
                    <label class="text-xs text-textMuted font-semibold mb-2 block ml-1">BOT NAME</label>
                    <input id="botName" class="modern-input p-3.5 text-sm" placeholder="e.g. My Awesome Bot">
                </div>
                <div>
                    <label class="text-xs text-textMuted font-semibold mb-2 block ml-1">BOT TOKEN (From BotFather)</label>
                    <input id="botToken" class="modern-input p-3.5 text-sm font-mono" placeholder="123456:ABC-DEF...">
                </div>
            </div>

            <div class="flex gap-3 mt-8">
                <button onclick="closeModal('createModal')" class="flex-1 btn-secondary py-3.5 text-sm">Cancel</button>
                <button onclick="createBot()" class="flex-1 btn-primary py-3.5 text-sm">Deploy Now</button>
            </div>
        </div>
    </div>

    <!-- [B] PAYMENT MODAL -->
    <div id="payModal" class="fixed inset-0 z-[2000] hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal('payModal')"></div>
        <div class="absolute bottom-0 left-0 right-0 md:top-1/2 md:bottom-auto md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 w-full max-w-md bg-[#0f172a] md:rounded-2xl rounded-t-2xl border-t md:border border-glassBorder p-6 shadow-2xl animate-slide-up">
            <div class="w-12 h-1 bg-gray-700 rounded-full mx-auto mb-6 md:hidden"></div>
            
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold text-white">Purchase <span id="payPlan" class="text-primary">Pro</span></h2>
                <button onclick="closeModal('payModal')" class="p-2 bg-gray-800 rounded-full hover:bg-gray-700"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            
            <div class="flex p-1 bg-gray-900 rounded-xl mb-6">
                <button onclick="setPayMode('cash')" id="tabCash" class="flex-1 py-2 text-xs font-semibold rounded-lg bg-gray-700 text-white shadow transition-all">Mobile Pay</button>
                <button onclick="setPayMode('ref')" id="tabRef" class="flex-1 py-2 text-xs font-semibold rounded-lg text-gray-400 hover:text-white transition-all">Points</button>
            </div>

            <!-- Cash Payment Section -->
            <div id="cashSec" class="animate-fade-in">
                <div class="glass-panel p-4 mb-5 flex items-center justify-between border-dashed border-gray-600">
                    <div>
                        <div class="text-[10px] text-textMuted font-bold uppercase tracking-wider mb-1">Send Money To (Nagad)</div>
                        <div class="text-lg font-mono font-bold text-white tracking-wide">01761494948</div>
                    </div>
                    <button onclick="copyToClipboard('01761494948')" class="p-2 bg-primary/10 rounded-lg text-primary hover:bg-primary/20"><i data-lucide="copy" class="w-5 h-5"></i></button>
                </div>
                <input id="trxId" class="modern-input p-3.5 text-sm text-center uppercase tracking-widest mb-6" placeholder="Enter TrxID">
                <button onclick="submitPay()" class="w-full btn-primary py-3.5 text-sm">Verify Payment</button>
            </div>
            
            <!-- Points Redemption Section -->
            <div id="refSec" class="hidden text-center py-4 animate-fade-in">
                <div class="w-16 h-16 bg-gradient-to-br from-primary to-accent rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-primary/30">
                    <i data-lucide="gift" class="w-8 h-8 text-white"></i>
                </div>
                <p class="text-sm text-gray-400 mb-6 px-4">Use your accumulated referral points to unlock this premium tier instantly.</p>
                <button onclick="submitPay()" class="w-full btn-secondary py-3.5 text-sm hover:bg-primary hover:border-primary">Redeem with Points</button>
            </div>
        </div>
    </div>

    <!-- [C] FULLSCREEN CODE EDITOR (MODERN DARK THEME) -->
    <div id="editorModal" class="fixed inset-0 z-[3000] hidden bg-[#0f172a] flex flex-col translate-x-full transition-transform duration-300 ease-in-out">
        <!-- Editor Header -->
        <div class="bg-[#1e293b] border-b border-gray-800 px-4 py-3 flex justify-between items-center shadow-md z-10">
            <button onclick="closeModal('editorModal')" class="flex items-center gap-2 text-gray-400 hover:text-white transition">
                <i data-lucide="chevron-left" class="w-5 h-5"></i>
                <span class="text-sm font-medium">Back</span>
            </button>
            <div class="flex items-center gap-2">
                <!-- AI Button -->
                <button onclick="openAI()" class="px-3 py-1.5 bg-gradient-to-r from-violet-600 to-indigo-600 text-white rounded-lg text-xs font-bold flex items-center gap-2 shadow-lg shadow-indigo-500/30 hover:shadow-indigo-500/50 transition transform hover:-translate-y-0.5">
                    <i data-lucide="sparkles" class="w-3.5 h-3.5"></i> AI Generate
                </button>
                <!-- Save Button -->
                <button onclick="saveCmd()" class="px-4 py-1.5 bg-gray-700 text-white rounded-lg text-xs font-bold hover:bg-green-600 transition flex items-center gap-2">
                    <i data-lucide="save" class="w-3.5 h-3.5"></i> Save
                </button>
            </div>
        </div>
        
        <!-- Editor Toolbar & Tabs -->
        <div class="bg-[#0f172a] p-2 border-b border-gray-800 overflow-x-auto">
            <div id="cmdList" class="flex gap-2 min-w-max px-2">
                <!-- Tabs injected here -->
            </div>
        </div>

        <!-- Editor Command Input -->
        <div class="p-4 bg-[#0f172a]">
            <div class="relative group">
                <span class="absolute left-4 top-3.5 text-gray-500 font-mono font-bold">/</span>
                <input id="cmdNameInput" class="modern-input py-3 pl-8 text-sm font-mono font-bold text-white bg-gray-900 border-gray-700 focus:border-primary" placeholder="command_name">
                <button onclick="deleteCmd()" class="absolute right-3 top-2.5 text-gray-500 hover:text-red-500 transition p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            </div>
        </div>
        
        <!-- Code Area (Monaco/Prism Style) -->
        <div class="flex-1 relative bg-[#0d1117] overflow-hidden">
            <textarea id="cmdCodeInput" class="w-full h-full bg-transparent text-gray-300 font-mono text-sm p-4 resize-none focus:outline-none leading-6 z-10 relative" spellcheck="false" placeholder="// Write your logic here...&#10;// Example: ctx.reply('Hello!');"></textarea>
            <!-- Syntax Highlight Overlay (Simplified for this version) -->
        </div>
    </div>

    <!-- [D] AI PROMPT MODAL (FRONTEND GENERATION) -->
    <div id="aiModal" class="fixed inset-0 z-[4000] hidden">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-md transition-opacity" onclick="closeModal('aiModal')"></div>
        <div class="absolute bottom-0 left-0 right-0 md:top-1/2 md:bottom-auto md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 w-full max-w-md bg-[#0f172a] md:rounded-2xl rounded-t-2xl border border-glassBorder p-6 shadow-2xl animate-scale-in">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-violet-500 to-fuchsia-500 flex items-center justify-center shadow-lg shadow-violet-500/20">
                    <i data-lucide="bot" class="w-6 h-6 text-white"></i>
                </div>
                <div>
                    <h3 class="text-white font-bold text-lg">AI Architect</h3>
                    <p class="text-xs text-gray-400">Describe what you want, get code instantly.</p>
                </div>
            </div>
            
            <textarea id="aiPrompt" class="modern-input h-32 p-4 text-sm resize-none mb-4 bg-gray-900 border-gray-700 focus:border-violet-500" placeholder="e.g. Create a menu with 3 buttons: Bank, PayPal, and Crypto..."></textarea>
            
            <div class="flex gap-3">
                <button onclick="closeModal('aiModal')" class="flex-1 btn-secondary py-3 text-sm">Close</button>
                <button onclick="generateAI()" class="flex-1 btn-primary py-3 text-sm bg-gradient-to-r from-violet-600 to-fuchsia-600 border-none">
                    <i data-lucide="sparkles" class="w-4 h-4 inline mr-1"></i> Generate
                </button>
            </div>
        </div>
    </div>

    <!-- =========================================================================================== -->
    <!-- 4. JAVASCRIPT LOGIC (ROBUST & EXPANDED) -->
    <!-- =========================================================================================== -->
    <script>
        // --- 1. INITIALIZATION & SETUP ---
        
        // Initialize Icons
        lucide.createIcons();
        
        // Telegram WebApp Object
        const tg = window.Telegram.WebApp;
        
        // User Data State (Fallback for Development)
        const user = tg.initDataUnsafe?.user || { id: '7605281774', first_name: 'Admin', username: 'admin' };
        
        // App State Variables
        let currentBotId = null;
        let payDetails = {};
        let payMode = 'cash';
        let activeTimers = {};

        // Security Warning
        if (!tg.initData && !tg.initDataUnsafe?.user) {
           console.log("‚ÑπÔ∏è Running in Dev Mode / Browser");
        }
        
        // Setup Telegram UI
        tg.expand();
        tg.setHeaderColor('#0f172a');
        tg.setBackgroundColor('#020617');
        tg.enableClosingConfirmation();

        // --- 2. NOTIFICATION SYSTEM (TOASTS) ---
        
        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            
            // Icon Selection
            let iconName = 'info';
            let colorClass = 'text-primary';
            if(type === 'success') { iconName = 'check-circle'; colorClass = 'text-success'; }
            if(type === 'error') { iconName = 'alert-triangle'; colorClass = 'text-danger'; }

            el.className = 'toast';
            el.innerHTML = `
                <i data-lucide="${iconName}" class="w-5 h-5 ${colorClass}"></i>
                <span class="text-sm font-medium text-white">${msg}</span>
            `;
            
            container.appendChild(el);
            lucide.createIcons();
            
            // Haptic Feedback
            if(type === 'success') tg.HapticFeedback.notificationOccurred('success');
            else if(type === 'error') tg.HapticFeedback.notificationOccurred('error');
            
            // Auto Remove
            setTimeout(() => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(-10px)';
                setTimeout(() => el.remove(), 300);
            }, 3000);
        }

        // --- 3. APPLICATION STARTUP LOGIC ---

        async function init() {
            // Update Header
            document.getElementById('userName').innerText = user.first_name;
            document.getElementById('userAvatar').src = user.photo_url || `https://ui-avatars.com/api/?name=${user.first_name}&background=6366f1&color=fff&bold=true`;

            try {
                // Fetch All Data
                const response = await fetch('/api/bots', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        userId: user.id.toString(), 
                        username: user.username, 
                        firstName: user.first_name 
                    })
                });
                
                const data = await response.json();
                
                if(!data.success) throw new Error("API Failure");

                // Update UI Stats
                const u = data.user;
                const planEl = document.getElementById('planBadge');
                planEl.innerText = `${u.plan.toUpperCase()}`;
                
                if(u.plan !== 'Free') {
                    planEl.className = "px-3 py-1.5 rounded-full bg-primary/10 border border-primary/30 text-xs font-bold text-primary shadow-lg shadow-primary/20";
                }

                document.getElementById('refCount').innerText = u.referrals;
                document.getElementById('limitBadge').innerText = `${data.bots.length}/${u.botLimit}`;

                // Render the List
                renderBots(data.bots);

                // Reveal App
                setTimeout(() => {
                    document.getElementById('loader').classList.add('opacity-0', 'pointer-events-none');
                    document.getElementById('app').classList.remove('hidden', 'opacity-0');
                }, 800);

            } catch (error) {
                console.error(error);
                showToast("Connection Error", 'error');
                document.getElementById('loader').innerHTML = `<div class="text-danger font-bold">Failed to load system.</div>`;
            }
        }

        // --- 4. RENDER LOGIC (GLASS CARDS) ---

        function renderBots(bots) {
            const container = document.getElementById('botsContainer');
            container.innerHTML = '';
            
            Object.values(activeTimers).forEach(clearInterval);
            activeTimers = {};

            if(!bots || bots.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }
            document.getElementById('emptyState').classList.add('hidden');

            bots.forEach(bot => {
                const isRun = bot.status === 'RUNNING';
                const card = document.createElement('div');
                card.className = `glass-panel p-4 flex flex-col gap-4 border-l-4 ${isRun ? 'border-l-success' : 'border-l-gray-600'}`;
                
                let uptimeHtml = '';
                if(isRun && bot.startedAt) {
                    uptimeHtml = `<span id="timer-${bot._id}" class="text-primary text-[10px] font-mono ml-auto bg-primary/10 px-2 py-1 rounded">00:00:00</span>`;
                    startUptimeTimer(bot._id, bot.startedAt);
                }

                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg ${isRun ? 'bg-success/20 text-success' : 'bg-gray-800 text-gray-500'} flex items-center justify-center">
                                <i data-lucide="server" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h4 class="text-white font-bold text-sm">${bot.name}</h4>
                                <div class="flex items-center gap-2 mt-0.5">
                                    <div class="w-2 h-2 rounded-full ${isRun ? 'bg-success animate-pulse' : 'bg-gray-500'}"></div>
                                    <span class="text-xs text-gray-400 font-medium">${bot.status}</span>
                                </div>
                            </div>
                        </div>
                        ${uptimeHtml}
                    </div>
                    
                    <div class="grid grid-cols-${isRun ? '3' : '2'} gap-2 pt-2 border-t border-gray-700/50">
                        ${isRun ? `
                            <button onclick="restartBot('${bot._id}')" class="py-2 bg-gray-800 rounded-lg text-xs font-semibold text-white hover:bg-gray-700 transition">Reboot</button>
                            <button onclick="toggleBot(this, '${bot._id}', 'stop')" class="py-2 bg-danger/10 rounded-lg text-xs font-semibold text-danger hover:bg-danger/20 transition">Stop</button>
                            <button onclick="openEditor('${bot._id}')" class="py-2 bg-primary/10 rounded-lg text-xs font-semibold text-primary hover:bg-primary/20 transition">Console</button>
                        ` : `
                            <button onclick="toggleBot(this, '${bot._id}', 'start')" class="py-2.5 bg-success/10 rounded-lg text-xs font-bold text-success hover:bg-success/20 transition flex items-center justify-center gap-2">
                                <i data-lucide="power" class="w-3 h-3"></i> Start Server
                            </button>
                            <button onclick="deleteBot('${bot._id}')" class="py-2.5 bg-gray-800 rounded-lg text-xs font-semibold text-gray-400 hover:text-danger hover:bg-gray-700 transition">Delete</button>
                        `}
                    </div>
                `;
                container.appendChild(card);
            });
            lucide.createIcons();
        }

        // --- 5. UTILITIES ---

        function startUptimeTimer(id, startStr) {
            const start = new Date(startStr).getTime();
            const update = () => {
                const diff = Date.now() - start;
                if(diff < 0) return;
                const h = Math.floor(diff / 3600000).toString().padStart(2, '0');
                const m = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
                const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
                const el = document.getElementById(`timer-${id}`);
                if(el) el.innerText = `${h}:${m}:${s}`;
            };
            activeTimers[id] = setInterval(update, 1000);
            update();
        }

        // --- 6. BOT ACTIONS ---

        async function createBot() {
            const btn = document.querySelector('#createModal button:last-child');
            const originalText = btn.innerHTML;
            btn.innerText = "Deploying..."; btn.disabled = true;

            const name = document.getElementById('botName').value;
            const token = document.getElementById('botToken').value;

            if(!name || !token) {
                showToast("Missing Fields", 'error');
                btn.innerHTML = originalText; btn.disabled = false;
                return;
            }

            try {
                const res = await fetch('/api/createBot', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name, token, userId: user.id.toString() })
                }).then(r => r.json());

                if(res.success) {
                    closeModal('createModal');
                    document.getElementById('botName').value = '';
                    document.getElementById('botToken').value = '';
                    showToast("Bot Deployed!", 'success');
                    init();
                } else {
                    showToast(res.message, 'error');
                }
            } catch(e) { showToast("Error", 'error'); }
            btn.innerHTML = originalText; btn.disabled = false;
        }

        async function toggleBot(btn, id, action) {
            const original = btn.innerText;
            btn.innerText = "...";
            try {
                const res = await fetch('/api/toggleBot', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ botId: id, action })
                }).then(r => r.json());
                
                if(res.success) {
                    showToast(action === 'start' ? "Server Online" : "Server Stopped", 'success');
                    init();
                } else {
                    showToast(res.message, 'error');
                    btn.innerText = original;
                }
            } catch(e) { btn.innerText = original; }
        }

        async function restartBot(id) {
            showToast("Rebooting...", 'info');
            await fetch('/api/restartBot', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ botId: id })
            });
            init();
        }

        function deleteBot(id) {
            tg.showConfirm("Are you sure you want to delete this bot?", (ok) => {
                if(ok) {
                    fetch('/api/deleteBot', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ botId: id })
                    }).then(() => {
                        showToast("Bot Deleted", 'info');
                        init();
                    });
                }
            });
        }

        // --- 7. EDITOR & AI SYSTEM (FRONTEND ONLY) ---

        async function openEditor(id) {
            currentBotId = id;
            const el = document.getElementById('editorModal');
            el.classList.remove('hidden');
            setTimeout(() => el.classList.remove('translate-x-full'), 10);
            
            const res = await fetch('/api/getCommands', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ botId: id })
            }).then(r => r.json());
            
            renderChips(res);
            newCmd();
        }

        function renderChips(cmds) {
            const list = document.getElementById('cmdList');
            list.innerHTML = `
                <button onclick="newCmd()" class="px-3 py-1.5 bg-primary text-white rounded-md text-xs font-bold border border-primary hover:bg-primaryHover transition flex items-center gap-1 shadow-md">
                    <i data-lucide="plus" class="w-3 h-3"></i> New
                </button>
            `;
            
            Object.entries(cmds).forEach(([name, code]) => {
                const btn = document.createElement('button');
                btn.className = 'px-3 py-1.5 bg-gray-800 border border-gray-700 text-gray-300 rounded-md text-xs font-mono hover:text-white hover:bg-gray-700 transition whitespace-nowrap';
                btn.innerText = '/' + name;
                btn.onclick = () => {
                    document.getElementById('cmdNameInput').value = name;
                    document.getElementById('cmdCodeInput').value = code;
                };
                list.appendChild(btn);
            });
            lucide.createIcons();
        }

        function newCmd() {
            document.getElementById('cmdNameInput').value = '';
            document.getElementById('cmdCodeInput').value = '';
        }

        async function saveCmd() {
            const name = document.getElementById('cmdNameInput').value;
            const code = document.getElementById('cmdCodeInput').value;
            if(!name) return showToast("Command name required", 'error');

            await fetch('/api/saveCommand', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ botId: currentBotId, command: name, code })
            });
            showToast("Saved!", 'success');
            openEditor(currentBotId);
        }

        async function deleteCmd() {
            const name = document.getElementById('cmdNameInput').value;
            if(name && confirm('Delete /'+name+'?')) {
                await fetch('/api/deleteCommand', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ botId: currentBotId, command: name })
                });
                openEditor(currentBotId);
            }
        }

        // --- 8. AI GENERATION (FRONTEND WEBSOCKET) ---
        // This connects directly to the AI service, bypassing the server as requested.

        function openAI() { openModal('aiModal'); }

        function generateAI() {
            const prompt = document.getElementById('aiPrompt').value;
            if(!prompt) return;
            
            closeModal('aiModal');
            const target = document.getElementById('cmdCodeInput');
            target.value = "// ü§ñ AI is thinking...\n// Generating code with Glass UI style...";
            
            // Establish Connection
            const ws = new WebSocket("wss://backend.buildpicoapps.com/ask_ai_streaming_v2");
            
            ws.addEventListener("open", () => {
                // STRICT PROMPT INJECTION to force the specific format
                const strictPrompt = `
                    ACT AS: Expert Telegram Bot Developer.
                    TASK: Write raw JavaScript code logic for Telegraf.js v4.
                    
                    STRICT OUTPUT RULES:
                    1. NO 'bot.command', NO 'bot.on', NO 'new Telegraf'.
                    2. ONLY write the internal logic inside the function.
                    3. YOU MUST USE THIS EXACT FORMAT FOR REPLIES:
                       ctx.replyWithHTML(
                           'Your Text Here',
                           Markup.inlineKeyboard([
                               Markup.button.callback('Button Name', 'callback_data'),
                               ...
                           ])
                       );
                    4. Do not use Markdown backticks.
                    
                    USER REQUEST: ${prompt}
                `;

                ws.send(JSON.stringify({
                    appId: "truth-choose", // Using a public AppID for demo purposes
                    prompt: strictPrompt
                }));
            });
            
            let accumulated = "";
            ws.addEventListener("message", (e) => {
                if(target.value.startsWith("//")) target.value = "";
                accumulated += e.data;
                // Cleanup Markdown if AI still adds it
                let clean = accumulated.replace(/```javascript/g, '').replace(/```/g, '').trim();
                target.value = clean;
                target.scrollTop = target.scrollHeight;
            });
            
            ws.addEventListener("close", () => showToast("Code Generated!", 'success'));
            ws.addEventListener("error", () => {
                target.value = "// Error connecting to AI service.";
                showToast("AI Error", 'error');
            });
        }

        // --- 9. PAYMENTS & UTILS ---

        function openPay(plan, price) {
            payDetails = { plan, price };
            document.getElementById('payPlan').innerText = plan;
            setPayMode('cash');
            openModal('payModal');
        }

        function setPayMode(mode) {
            payMode = mode;
            const cash = document.getElementById('cashSec');
            const ref = document.getElementById('refSec');
            const btnCash = document.getElementById('tabCash');
            const btnRef = document.getElementById('tabRef');

            if(mode === 'cash') {
                cash.classList.remove('hidden'); ref.classList.add('hidden');
                btnCash.className = "flex-1 py-2 text-xs font-semibold rounded-lg bg-gray-700 text-white shadow transition-all";
                btnRef.className = "flex-1 py-2 text-xs font-semibold rounded-lg text-gray-400 hover:text-white transition-all";
            } else {
                ref.classList.remove('hidden'); cash.classList.add('hidden');
                btnRef.className = "flex-1 py-2 text-xs font-semibold rounded-lg bg-primary text-white shadow transition-all";
                btnCash.className = "flex-1 py-2 text-xs font-semibold rounded-lg text-gray-400 hover:text-white transition-all";
            }
        }

        async function submitPay() {
            const trx = document.getElementById('trxId').value;
            if(payMode === 'cash' && !trx) return showToast("Enter TrxID", 'error');

            const res = await fetch('/api/submit-payment', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    userId: user.id.toString(), user: user.username,
                    method: payMode === 'cash' ? 'manual' : 'referral',
                    plan: payDetails.plan, amount: payDetails.price, trxId: trx
                })
            }).then(r => r.json());

            if(res.success) {
                closeModal('payModal');
                showToast("Submitted!", 'success');
                if(payMode === 'referral') init();
            } else {
                showToast(res.message, 'error');
            }
        }

        function copyToClipboard(txt) { 
            navigator.clipboard.writeText(txt); 
            showToast("Copied!", 'success'); 
        }
        
        function copyLink() { 
            copyToClipboard(`https://t.me/lagahostbot?start=${user.id}`); 
        }

        function openModal(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function closeModal(id) { 
            const el = document.getElementById(id);
            if(id === 'editorModal') {
                el.classList.add('translate-x-full');
            }
            setTimeout(() => el.classList.add('hidden'), 300);
        }

        // Start App
        window.onload = init;

    </script>
</body>
</html>
