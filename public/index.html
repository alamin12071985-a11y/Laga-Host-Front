<!-- 
  =============================================================================
  PROJECT: LAGA HOST FRONTEND (CYBER CORE UI)
  VERSION: 6.1.0 (Full Enterprise Build)
  DESCRIPTION: The interface for the Telegram Bot Hosting Platform.
  UPDATES: Connected to Server-Side AI & Async Logic.
  =============================================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>Laga Host: Cyber Core Enterprise</title>
    
    <!-- EXTERNAL LIBRARIES -->
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Tailwind CSS (Utility First Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons (Vector Icons) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- GOOGLE FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&family=JetBrains+Mono:wght@100;300;400;700&display=swap" rel="stylesheet">

    <!-- TAILWIND CUSTOM CONFIGURATION -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Rajdhani', 'sans-serif'],     // Body Text
                        mono: ['JetBrains Mono', 'monospace'], // Code & Numbers
                        display: ['Orbitron', 'sans-serif']    // Headers
                    },
                    colors: {
                        black: '#000000',
                        dark: {
                            900: '#050505',
                            800: '#0A0A0A',
                            700: '#121212',
                        },
                        brand: {
                            cyan: '#06B6D4', // Primary Color (Neon Blue)
                            blue: '#3B82F6', // Secondary Accent
                            green: '#10B981', // Success State
                            red: '#EF4444',   // Danger/Error State
                        }
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <!-- CUSTOM ADVANCED CSS STYLES -->
    <style>
        /* BASE RESET & VARIABLES */
        :root {
            --color-primary: #06B6D4;
            --color-bg: #000000;
            --color-panel: rgba(10, 10, 10, 0.95);
            --color-border: #1f1f1f;
        }

        body {
            background-color: var(--color-bg);
            color: #e0e0e0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* ---------------------------------------------------- */
        /* CYBERPUNK GRID BACKGROUND */
        /* ---------------------------------------------------- */
        .cyber-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-image: 
                linear-gradient(to right, rgba(6, 182, 212, 0.05) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(6, 182, 212, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: -2;
            pointer-events: none;
        }

        /* Vignette Effect */
        .cyber-grid::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 50%, transparent 0%, #000000 90%);
        }

        /* ---------------------------------------------------- */
        /* SCANLINE ANIMATION */
        /* ---------------------------------------------------- */
        .scanline {
            width: 100%;
            height: 100px;
            z-index: -1;
            background: linear-gradient(0deg, rgba(0,0,0,0) 0%, rgba(6, 182, 212, 0.04) 50%, rgba(0,0,0,0) 100%);
            opacity: 0.4;
            position: absolute;
            bottom: 100%;
            animation: scanline 10s linear infinite;
            pointer-events: none;
        }

        @keyframes scanline {
            0% { bottom: 100%; }
            100% { bottom: -100%; }
        }

        /* ---------------------------------------------------- */
        /* GLASS PANEL (THE CARDS) */
        /* ---------------------------------------------------- */
        .cyber-card {
            background: var(--color-panel);
            border: 1px solid var(--color-border);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 4px;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        /* Hover Border Glow */
        .cyber-card:hover {
            border-color: #333;
            transform: translateY(-2px);
            box-shadow: 0 10px 30px -10px rgba(6, 182, 212, 0.15);
        }

        /* ---------------------------------------------------- */
        /* INPUT FIELDS */
        /* ---------------------------------------------------- */
        .cyber-input {
            background: #050505;
            border: 1px solid #2a2a2a;
            color: var(--color-primary);
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.3s ease;
            width: 100%;
        }

        .cyber-input:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.2);
            outline: none;
        }

        .cyber-input::placeholder {
            color: #444;
            font-family: 'Rajdhani', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ---------------------------------------------------- */
        /* BUTTONS */
        /* ---------------------------------------------------- */
        .btn-cyber {
            background: var(--color-primary);
            color: #000;
            font-weight: 800;
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            /* Angled Corners */
            clip-path: polygon(
                12px 0, 100% 0, 
                100% calc(100% - 12px), 
                calc(100% - 12px) 100%, 
                0 100%, 0 12px
            );
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }

        .btn-cyber:active {
            transform: scale(0.98);
        }

        .btn-cyber:hover {
            background: #22d3ee;
            box-shadow: 0 0 25px rgba(6, 182, 212, 0.5);
        }

        /* Outline Button Variant */
        .btn-outline {
            background: transparent;
            border: 1px solid var(--color-primary);
            color: var(--color-primary);
            font-weight: 700;
            font-family: 'Rajdhani', sans-serif;
            clip-path: polygon(
                8px 0, 100% 0, 
                100% calc(100% - 8px), 
                calc(100% - 8px) 100%, 
                0 100%, 0 8px
            );
            transition: all 0.3s;
        }

        .btn-outline:hover {
            background: rgba(6, 182, 212, 0.1);
        }

        /* ---------------------------------------------------- */
        /* LOADING SPINNER (HEXAGON) */
        /* ---------------------------------------------------- */
        .hex-loader {
            width: 60px;
            height: 60px;
            background: var(--color-primary);
            clip-path: polygon(50% 0%, 95% 25%, 95% 75%, 50% 100%, 5% 75%, 5% 25%);
            animation: spin 3s linear infinite;
        }
        
        .hex-inner {
            width: 50px;
            height: 50px;
            background: #000;
            clip-path: polygon(50% 0%, 95% 25%, 95% 75%, 50% 100%, 5% 75%, 5% 25%);
            position: relative;
            top: 5px;
            left: 5px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ---------------------------------------------------- */
        /* UTILITIES */
        /* ---------------------------------------------------- */
        ::-webkit-scrollbar {
            width: 6px;
            height: 4px;
        }
        ::-webkit-scrollbar-track {
            background: #000;
        }
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }
    </style>
</head>
<body class="min-h-screen pb-40 select-none">

    <!-- BACKGROUND LAYERS -->
    <div class="cyber-grid"></div>
    <div class="scanline"></div>

    <!-- TOAST NOTIFICATION CONTAINER -->
    <div id="toast-container" class="fixed top-6 left-0 right-0 z-[9999] flex flex-col items-center gap-3 pointer-events-none px-4"></div>

    <!-- =========================================================================================== -->
    <!-- 1. SYSTEM BOOT LOADER (INITIAL SCREEN) -->
    <!-- =========================================================================================== -->
    <div id="loader" class="fixed inset-0 z-[1000] bg-black flex flex-col items-center justify-center transition-opacity duration-1000">
        <div class="relative mb-6">
            <div class="hex-loader">
                <div class="hex-inner"></div>
            </div>
            <div class="absolute inset-0 flex items-center justify-center">
                <div class="w-2 h-2 bg-brand-cyan rounded-full animate-ping"></div>
            </div>
        </div>
        <div class="text-brand-cyan font-display text-2xl tracking-[0.2em] font-bold">SYSTEM BOOT</div>
        <div class="text-gray-600 text-xs mt-3 font-mono flex items-center gap-2">
            <span class="w-1.5 h-1.5 bg-brand-green rounded-full animate-pulse"></span> 
            CONNECTING TO NEURAL NET...
        </div>
    </div>

    <!-- =========================================================================================== -->
    <!-- 2. MAIN DASHBOARD INTERFACE -->
    <!-- =========================================================================================== -->
    <main id="app" class="hidden opacity-0 transition duration-1000 px-5 pt-8 max-w-lg mx-auto relative z-10">
        
        <!-- HEADER SECTION -->
        <header class="flex justify-between items-center mb-10 border-b border-gray-800 pb-5">
            <div class="flex items-center gap-4">
                <!-- User Avatar -->
                <div class="relative group cursor-pointer">
                    <img id="userAvatar" src="" class="w-14 h-14 bg-dark-900 border border-gray-800 object-cover group-hover:border-brand-cyan transition duration-500" 
                         style="clip-path: polygon(20% 0, 100% 0, 100% 80%, 80% 100%, 0 100%, 0 20%);">
                    <div class="absolute -bottom-1 -right-1 w-3 h-3 bg-brand-green shadow-[0_0_10px_#10B981]"></div>
                </div>
                
                <!-- User Name & Title -->
                <div>
                    <h1 class="text-white font-display font-bold text-xl leading-none tracking-wide">COMMAND CENTER</h1>
                    <div class="text-brand-cyan font-mono text-xs mt-1.5 flex items-center gap-1">
                        OPERATOR: <span id="userName" class="text-white font-bold">UNKNOWN</span>
                    </div>
                </div>
            </div>

            <!-- Plan Badge -->
            <div id="planBadge" class="text-xs font-mono font-bold border border-brand-cyan text-brand-cyan px-4 py-1.5 bg-brand-cyan/10 shadow-[0_0_15px_rgba(6,182,212,0.3)] tracking-widest">
                FREE TIER
            </div>
        </header>

        <!-- DASHBOARD STATS GRID -->
        <div class="grid grid-cols-2 gap-4 mb-10">
            <!-- Points Card -->
            <div class="cyber-card p-5 group">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-gray-500 text-[10px] font-mono tracking-widest">CREDITS (PTS)</span>
                    <i data-lucide="crosshair" class="w-4 h-4 text-gray-600 group-hover:text-brand-cyan transition duration-300"></i>
                </div>
                <div id="refCount" class="text-4xl font-display font-bold text-white leading-none group-hover:text-brand-cyan transition duration-300">0</div>
                <button onclick="copyLink()" class="mt-4 text-[10px] text-brand-cyan border border-brand-cyan/30 w-full py-2 hover:bg-brand-cyan/10 transition uppercase font-bold tracking-widest flex items-center justify-center gap-2">
                    <i data-lucide="share-2" class="w-3 h-3"></i> INVITE UNIT
                </button>
            </div>
            
            <!-- Server Load Card -->
            <div class="cyber-card p-5">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-gray-500 text-[10px] font-mono tracking-widest">CPU LOAD</span>
                    <i data-lucide="activity" class="w-4 h-4 text-brand-cyan animate-pulse"></i>
                </div>
                <div id="limitBadge" class="text-4xl font-display font-bold text-white leading-none">0/1</div>
                
                <!-- Animated Progress Bar -->
                <div class="w-full h-1.5 bg-dark-900 mt-5 overflow-hidden relative">
                    <div class="absolute inset-0 bg-brand-cyan/10"></div>
                    <div class="h-full bg-brand-cyan animate-pulse w-1/2 shadow-[0_0_10px_#06B6D4]"></div>
                </div>
            </div>
        </div>

        <!-- MAIN ACTION BUTTON (DEPLOY) -->
        <button onclick="openModal('createModal')" class="w-full btn-cyber py-5 mb-10 flex items-center justify-center gap-3 shadow-[0_0_20px_rgba(6,182,212,0.4)] group relative overflow-hidden">
            <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition duration-500"></div>
            <i data-lucide="plus-square" class="w-5 h-5 group-hover:rotate-90 transition duration-300"></i> 
            <span class="tracking-[0.15em]">DEPLOY NEW INSTANCE</span>
        </button>

        <!-- SERVER LIST CONTAINER -->
        <div class="mb-12">
            <div class="flex items-center gap-3 mb-5 border-l-4 border-brand-cyan pl-4">
                <i data-lucide="server" class="w-5 h-5 text-brand-cyan"></i>
                <h3 class="text-sm font-mono text-gray-400 tracking-[0.25em] font-bold">ACTIVE_NODES</h3>
            </div>
            
            <div id="botsContainer" class="space-y-5 min-h-[120px]">
                <!-- Bots will be injected here via JS -->
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden cyber-card p-8 text-center border-dashed border-gray-800 opacity-60">
                <i data-lucide="hard-drive" class="w-10 h-10 text-gray-600 mx-auto mb-3"></i>
                <p class="text-xs font-mono text-gray-500">NO ACTIVE NODES DETECTED IN SECTOR</p>
            </div>
        </div>

        <!-- UPGRADE PLANS SECTION -->
        <div class="border-t border-gray-800 pt-8 pb-8">
            <h3 class="text-center text-xs font-mono text-gray-600 mb-6 tracking-[0.3em]">UPGRADE MODULES</h3>
            <div class="grid grid-cols-2 gap-4">
                <!-- Pro Plan -->
                <div onclick="openPay('Pro', 50)" class="cyber-card p-4 cursor-pointer hover:bg-dark-900 transition group relative overflow-hidden border-hover-animate">
                    <div class="absolute top-0 right-0 p-1.5 bg-brand-blue/20 rounded-bl-xl"><i data-lucide="zap" class="w-4 h-4 text-brand-blue"></i></div>
                    <div class="text-white font-bold font-display text-lg mb-1">PRO CORE</div>
                    <div class="text-[10px] text-gray-500 font-mono mb-3">5 SLOTS // PRIORITY CPU</div>
                    <div class="text-2xl font-bold text-brand-blue font-mono">50‡ß≥</div>
                </div>
                <!-- VIP Plan -->
                <div onclick="openPay('VIP', 80)" class="cyber-card p-4 cursor-pointer hover:bg-dark-900 transition group relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-1.5 bg-brand-cyan/20 rounded-bl-xl"><i data-lucide="crown" class="w-4 h-4 text-brand-cyan"></i></div>
                    <div class="text-white font-bold font-display text-lg mb-1">VIP CORE</div>
                    <div class="text-[10px] text-gray-500 font-mono mb-3">10 SLOTS // MAX POWER</div>
                    <div class="text-2xl font-bold text-brand-cyan font-mono">80‡ß≥</div>
                </div>
            </div>
        </div>

    </main>

    <!-- =========================================================================================== -->
    <!-- 3. INTERACTIVE MODALS (POPUPS) -->
    <!-- =========================================================================================== -->

    <!-- [A] CREATE BOT MODAL -->
    <div id="createModal" class="fixed inset-0 z-[5000] hidden bg-black/95 flex items-center justify-center p-5 backdrop-blur-md transition-all duration-300">
        <div class="cyber-card w-full max-w-sm p-8 shadow-[0_0_50px_rgba(6,182,212,0.2)] border-brand-cyan/40">
            <h2 class="text-brand-cyan font-display text-xl mb-8 font-bold border-b border-gray-800 pb-4 flex items-center gap-3">
                <i data-lucide="terminal" class="w-6 h-6"></i> INITIALIZE NODE
            </h2>
            
            <div class="space-y-6">
                <div>
                    <label class="text-[10px] text-gray-500 font-mono block mb-2 tracking-widest">NODE_IDENTIFIER (NAME)</label>
                    <input id="botName" class="cyber-input p-4 text-sm rounded-none" placeholder="e.g. Omega_Server_01">
                </div>
                <div>
                    <label class="text-[10px] text-gray-500 font-mono block mb-2 tracking-widest">ACCESS_TOKEN (FROM BOTFATHER)</label>
                    <input id="botToken" class="cyber-input p-4 text-sm rounded-none font-mono" placeholder="123456:ABC-DEF...">
                </div>
            </div>

            <div class="flex gap-4 mt-8">
                <button onclick="closeModal('createModal')" class="flex-1 py-4 border border-gray-800 text-gray-500 text-xs font-bold hover:text-white hover:bg-dark-900 transition uppercase tracking-widest">ABORT</button>
                <button onclick="createBot()" class="flex-1 btn-cyber text-xs tracking-widest">DEPLOY SYSTEM</button>
            </div>
        </div>
    </div>

    <!-- [B] PAYMENT MODAL -->
    <div id="payModal" class="fixed inset-0 z-[5000] hidden bg-black/95 flex items-center justify-center p-5 backdrop-blur-md">
        <div class="cyber-card w-full max-w-sm p-6">
            <div class="flex justify-between items-center mb-6 border-b border-gray-800 pb-3">
                <h2 class="text-white font-mono font-bold text-sm tracking-[0.2em]">PURCHASE: <span id="payPlan" class="text-brand-cyan">PRO</span></h2>
                <button onclick="closeModal('payModal')" class="text-gray-500 hover:text-white transition"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            
            <div class="flex gap-2 mb-8 p-1 bg-black border border-gray-800">
                <button onclick="setPayMode('cash')" id="tabCash" class="flex-1 py-3 bg-dark-900 text-white text-[10px] font-bold font-mono transition">MOBILE PAY</button>
                <button onclick="setPayMode('ref')" id="tabRef" class="flex-1 py-3 border border-transparent text-gray-500 text-[10px] font-bold font-mono hover:text-gray-300 transition">POINTS REDEEM</button>
            </div>

            <!-- Cash Payment Section -->
            <div id="cashSec">
                <div class="bg-dark-900 p-5 mb-6 border border-gray-800 relative overflow-hidden group">
                    <div class="absolute -right-4 -top-4 text-gray-800 group-hover:text-gray-700 transition"><i data-lucide="smartphone" class="w-24 h-24 opacity-20"></i></div>
                    <div class="text-[10px] text-gray-500 font-mono mb-2 tracking-widest">DESTINATION WALLET (NAGAD)</div>
                    <div class="text-xl font-mono text-white tracking-[0.1em] flex justify-between items-center z-10 relative">
                        01761494948 
                        <button onclick="copyToClipboard('01761494948')" class="text-brand-cyan hover:text-white transition hover:scale-110"><i data-lucide="copy" class="w-5 h-5"></i></button>
                    </div>
                </div>
                <input id="trxId" class="cyber-input p-4 text-center text-sm mb-6 tracking-[0.2em] uppercase" placeholder="ENTER TRX ID">
                <button onclick="submitPay()" class="w-full btn-cyber py-4 text-xs tracking-widest">VERIFY SIGNAL</button>
            </div>
            
            <!-- Points Redemption Section -->
            <div id="refSec" class="hidden text-center py-8">
                <div class="w-16 h-16 border border-brand-blue rounded-full flex items-center justify-center mx-auto mb-4 bg-brand-blue/10">
                    <i data-lucide="layers" class="w-8 h-8 text-brand-blue"></i>
                </div>
                <div class="text-xs text-gray-400 font-mono mb-8 px-6 leading-relaxed">EXCHANGE YOUR ACCUMULATED POINTS FOR ACCESS TIER UPGRADE.</div>
                <button onclick="submitPay()" class="w-full btn-outline py-4 text-xs hover:bg-brand-blue hover:text-white transition tracking-widest">CONFIRM EXCHANGE</button>
            </div>
        </div>
    </div>

    <!-- [C] FULLSCREEN CODE EDITOR -->
    <div id="editorModal" class="fixed inset-0 z-[6000] hidden bg-black flex flex-col translate-x-full transition-transform duration-500 ease-in-out">
        <!-- Editor Header -->
        <div class="bg-dark-900 border-b border-gray-800 p-4 flex justify-between items-center">
            <button onclick="closeModal('editorModal')" class="text-gray-500 hover:text-white p-2 border border-transparent hover:border-gray-700 rounded"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
            <span class="text-brand-cyan font-mono text-xs font-bold tracking-[0.3em] uppercase">TERMINAL_EDITOR_V6</span>
            <div class="flex gap-3">
                <button onclick="openAI('code')" class="px-4 py-2 bg-brand-blue/10 text-brand-blue text-[10px] font-bold border border-brand-blue/30 hover:bg-brand-blue hover:text-white transition flex items-center gap-2">
                    <i data-lucide="cpu" class="w-3 h-3"></i> AI ASSIST
                </button>
                <button onclick="saveCmd()" class="px-5 py-2 bg-brand-cyan text-black text-[10px] font-bold hover:bg-cyan-400 transition flex items-center gap-2 clip-path-slant">
                    <i data-lucide="save" class="w-3 h-3"></i> WRITE TO DB
                </button>
            </div>
        </div>
        
        <!-- Editor Body -->
        <div class="flex-1 flex flex-col p-4">
            <!-- File Tabs -->
            <div id="cmdList" class="flex gap-3 overflow-x-auto pb-4 mb-4 border-b border-gray-900 no-scrollbar">
                <!-- Chips injected here -->
            </div>
            
            <!-- Command Name Input -->
            <div class="relative mb-4 group">
                <span class="absolute left-4 top-3.5 text-gray-600 font-mono">/</span>
                <input id="cmdNameInput" class="cyber-input w-full py-3 pl-8 text-sm font-mono border-gray-800 focus:border-brand-cyan" placeholder="command_name">
                <button onclick="deleteCmd()" class="absolute right-3 top-2.5 text-brand-red hover:text-red-400 p-1 border border-transparent hover:border-brand-red/30 rounded"><i data-lucide="trash" class="w-4 h-4"></i></button>
            </div>
            
            <!-- Code Text Area -->
            <div class="flex-1 relative border border-gray-800 bg-[#080808] overflow-hidden">
                <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-brand-cyan/20 to-transparent"></div>
                <textarea id="cmdCodeInput" class="w-full h-full bg-transparent text-gray-300 font-mono text-xs p-6 resize-none focus:outline-none leading-relaxed" spellcheck="false" placeholder="// INJECT JAVASCRIPT LOGIC HERE...&#10;// CONTEXT: ctx, bot, Markup, axios"></textarea>
            </div>
        </div>
    </div>

    <!-- [D] AI PROMPT MODAL -->
    <div id="aiModal" class="fixed inset-0 z-[7000] hidden bg-black/95 flex items-center justify-center p-6 backdrop-blur-md">
        <div class="cyber-card w-full max-w-sm p-5 border border-brand-blue/50 shadow-[0_0_30px_rgba(59,130,246,0.2)]">
            <div class="flex items-center gap-3 mb-4 text-brand-blue font-bold font-mono border-b border-gray-800 pb-2">
                <i data-lucide="brain-circuit" class="w-5 h-5"></i> 
                <span>AI ARCHITECT CORE</span>
            </div>
            <textarea id="aiPrompt" class="cyber-input w-full h-32 p-4 mb-4 text-xs resize-none" placeholder="Describe the required functionality (e.g., 'Create a button that replies with current time')..."></textarea>
            <div class="flex gap-3">
                <button onclick="closeModal('aiModal')" class="flex-1 py-3 bg-dark-900 text-gray-500 text-xs font-bold border border-gray-800 hover:text-white transition">CANCEL</button>
                <button onclick="generateAI()" class="flex-1 py-3 bg-brand-blue text-white text-xs font-bold shadow-[0_0_15px_#3B82F6] hover:bg-blue-600 transition tracking-widest">GENERATE</button>
            </div>
        </div>
    </div>

    <!-- =========================================================================================== -->
    <!-- 4. CORE JAVASCRIPT LOGIC -->
    <!-- =========================================================================================== -->
    <script>
        // --- 1. INITIALIZATION ---
        lucide.createIcons();
        const tg = window.Telegram.WebApp;
        const user = tg.initDataUnsafe?.user || { id: '7605281774', first_name: 'Admin', username: 'admin' };
        
        let currentBotId = null;
        let payDetails = {};
        let payMode = 'cash';
        let activeTimers = {};

        // Security Warning
        if (!tg.initData && !tg.initDataUnsafe?.user) {
           console.warn("‚ö†Ô∏è Running in Standalone Mode (Browser)");
        }
        
        // Setup Telegram UI
        tg.expand();
        tg.setHeaderColor('#000000');
        tg.setBackgroundColor('#000000');
        tg.enableClosingConfirmation();

        // --- 2. TOAST NOTIFICATIONS ---
        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            
            const styles = {
                success: 'border-brand-green text-brand-green bg-brand-green/10',
                error: 'border-brand-red text-brand-red bg-brand-red/10',
                info: 'border-brand-cyan text-brand-cyan bg-brand-cyan/10'
            };
            const iconMap = { success: 'check-circle', error: 'alert-triangle', info: 'info' };

            el.className = `flex items-center gap-3 px-5 py-3 border backdrop-blur-md shadow-lg font-mono text-xs font-bold transform transition-all duration-300 translate-y-[-20px] opacity-0 ${styles[type]}`;
            el.innerHTML = `<i data-lucide="${iconMap[type]}" class="w-4 h-4"></i><span class="tracking-wider">${msg.toUpperCase()}</span>`;
            
            container.appendChild(el);
            lucide.createIcons();
            
            requestAnimationFrame(() => el.classList.remove('translate-y-[-20px]', 'opacity-0'));
            
            if(type === 'success') tg.HapticFeedback.notificationOccurred('success');
            else if(type === 'error') tg.HapticFeedback.notificationOccurred('error');
            
            setTimeout(() => {
                el.classList.add('opacity-0', 'translate-y-[-20px]');
                setTimeout(() => el.remove(), 300);
            }, 3500);
        }

        // --- 3. STARTUP LOGIC ---
        async function init() {
            document.getElementById('userName').innerText = (user.first_name || 'USER').toUpperCase();
            document.getElementById('userAvatar').src = user.photo_url || `https://ui-avatars.com/api/?name=${user.first_name}&background=050505&color=06B6D4&bold=true`;

            try {
                const response = await fetch('/api/bots', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: user.id.toString(), username: user.username, firstName: user.first_name })
                });
                
                const data = await response.json();
                if(!data.success) throw new Error("API Failure");

                const u = data.user;
                const planEl = document.getElementById('planBadge');
                planEl.innerText = `${u.plan.toUpperCase()} TIER`;
                
                if(u.plan !== 'Free') {
                    planEl.className = "text-xs font-mono font-bold border border-brand-blue text-brand-blue px-4 py-1.5 bg-brand-blue/10 shadow-[0_0_15px_rgba(59,130,246,0.3)] tracking-widest";
                }

                document.getElementById('refCount').innerText = u.referrals;
                document.getElementById('limitBadge').innerText = `${data.bots.length}/${u.botLimit}`;

                renderBots(data.bots);

                setTimeout(() => {
                    document.getElementById('loader').classList.add('opacity-0', 'pointer-events-none');
                    document.getElementById('app').classList.remove('hidden', 'opacity-0');
                }, 1200);

            } catch (error) {
                console.error(error);
                showToast("NETWORK CONNECTION FAILURE", 'error');
                document.getElementById('loader').innerHTML = `<div class="text-brand-red font-mono font-bold blink">CRITICAL SYSTEM FAILURE</div>`;
            }
        }

        // --- 4. RENDER BOTS ---
        function renderBots(bots) {
            const container = document.getElementById('botsContainer');
            container.innerHTML = '';
            
            Object.values(activeTimers).forEach(clearInterval);
            activeTimers = {};

            if(!bots || bots.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }
            document.getElementById('emptyState').classList.add('hidden');

            bots.forEach(bot => {
                const isRun = bot.status === 'RUNNING';
                const card = document.createElement('div');
                card.className = `cyber-card p-5 border-l-4 transition-all duration-300 ${isRun ? 'border-l-brand-green' : 'border-l-gray-700'}`;
                
                let uptimeHtml = '';
                if(isRun && bot.startedAt) {
                    uptimeHtml = `<span id="timer-${bot._id}" class="text-brand-cyan ml-2 font-mono text-[10px] tracking-wider">CALCULATING...</span>`;
                    startUptimeTimer(bot._id, bot.startedAt);
                }

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-6">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-black border border-gray-800 flex items-center justify-center relative">
                                <i data-lucide="server" class="w-6 h-6 ${isRun ? 'text-brand-green' : 'text-gray-600'}"></i>
                                ${isRun ? '<div class="absolute inset-0 bg-brand-green/20 animate-pulse"></div>' : ''}
                            </div>
                            <div>
                                <div class="font-bold text-white text-base font-display tracking-wide">${bot.name}</div>
                                <div class="flex items-center gap-2 mt-1">
                                    <div class="w-1.5 h-1.5 rounded-full ${isRun ? 'bg-brand-green animate-pulse' : 'bg-brand-red'}"></div>
                                    <span class="text-[10px] font-mono text-gray-400 font-bold">${bot.status}</span>
                                    ${uptimeHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-${isRun ? '3' : '1'} gap-3">
                        ${isRun ? `
                            <button onclick="restartBot('${bot._id}')" class="py-3 bg-dark-900 border border-gray-800 text-[10px] font-bold text-brand-cyan hover:bg-gray-800 transition tracking-wider">REBOOT</button>
                            <button onclick="toggleBot(this, '${bot._id}', 'stop')" class="py-3 bg-dark-900 border border-gray-800 text-[10px] font-bold text-brand-red hover:bg-gray-800 transition tracking-wider">HALT</button>
                            <button onclick="openEditor('${bot._id}')" class="py-3 bg-dark-900 border border-gray-800 text-[10px] font-bold text-white hover:bg-gray-800 transition tracking-wider">CONSOLE</button>
                        ` : `
                            <div class="flex gap-3">
                                <button onclick="toggleBot(this, '${bot._id}', 'start')" class="flex-1 py-4 bg-brand-green/10 border border-brand-green/30 text-xs font-bold text-brand-green hover:bg-brand-green/20 transition tracking-widest shadow-lg shadow-green-900/20">INITIALIZE SYSTEM</button>
                                <button onclick="deleteBot('${bot._id}')" class="w-14 flex items-center justify-center bg-dark-900 border border-gray-800 text-gray-500 hover:text-brand-red hover:border-brand-red transition"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                            </div>
                        `}
                    </div>
                `;
                container.appendChild(card);
            });
            lucide.createIcons();
        }

        function startUptimeTimer(id, startStr) {
            const start = new Date(startStr).getTime();
            const update = () => {
                const diff = Date.now() - start;
                if(diff < 0) return;
                const h = Math.floor(diff / 3600000).toString().padStart(2, '0');
                const m = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
                const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
                const el = document.getElementById(`timer-${id}`);
                if(el) el.innerText = `UPTIME: ${h}:${m}:${s}`;
            };
            activeTimers[id] = setInterval(update, 1000);
            update();
        }

        // --- 5. BOT ACTIONS ---
        async function createBot() {
            const btn = document.querySelector('#createModal button:last-child');
            const originalText = btn.innerText;
            btn.innerText = "PROCESSING..."; btn.disabled = true;

            const name = document.getElementById('botName').value;
            const token = document.getElementById('botToken').value;

            if(!name || !token) {
                showToast("INPUT FIELDS REQUIRED", 'error');
                btn.innerText = originalText; btn.disabled = false;
                return;
            }

            try {
                const res = await fetch('/api/createBot', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name, token, userId: user.id.toString() })
                }).then(r => r.json());

                if(res.success) {
                    closeModal('createModal');
                    document.getElementById('botName').value = '';
                    document.getElementById('botToken').value = '';
                    showToast("SYSTEM DEPLOYED SUCCESSFULLY", 'success');
                    init();
                } else {
                    showToast(res.message, 'error');
                }
            } catch(e) { showToast("NETWORK ERROR", 'error'); }
            btn.innerText = originalText; btn.disabled = false;
        }

        async function toggleBot(btn, id, action) {
            const original = btn.innerText;
            btn.innerText = "...";
            try {
                const res = await fetch('/api/toggleBot', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ botId: id, action })
                }).then(r => r.json());
                if(res.success) {
                    showToast(action === 'start' ? "SYSTEM ONLINE" : "SYSTEM HALTED", action === 'start' ? 'success' : 'info');
                    init();
                } else {
                    showToast(res.message, 'error');
                    btn.innerText = original;
                }
            } catch(e) { btn.innerText = original; }
        }

        async function restartBot(id) {
            showToast("INITIATING REBOOT...", 'info');
            await fetch('/api/restartBot', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ botId: id })
            });
            init();
        }

        function deleteBot(id) {
            tg.showConfirm("WARNING: THIS ACTION IS IRREVERSIBLE. TERMINATE INSTANCE?", (ok) => {
                if(ok) {
                    fetch('/api/deleteBot', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ botId: id })
                    }).then(() => {
                        showToast("INSTANCE TERMINATED", 'info');
                        init();
                    });
                }
            });
        }

        // --- 6. CODE EDITOR & AI FIX ---
        async function openEditor(id) {
            currentBotId = id;
            const el = document.getElementById('editorModal');
            el.classList.remove('hidden');
            setTimeout(() => el.classList.remove('translate-x-full'), 10);
            
            const res = await fetch('/api/getCommands', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ botId: id })
            }).then(r => r.json());
            renderChips(res);
            newCmd();
        }

        function renderChips(cmds) {
            const list = document.getElementById('cmdList');
            list.innerHTML = `
                <button onclick="newCmd()" class="px-4 py-2 bg-brand-cyan text-black text-[10px] font-bold mr-2 border border-brand-cyan hover:bg-white transition flex items-center gap-1">
                    <i data-lucide="plus" class="w-3 h-3"></i> NEW
                </button>
            `;
            Object.entries(cmds).forEach(([name, code]) => {
                const btn = document.createElement('button');
                btn.className = 'px-4 py-2 bg-dark-900 border border-gray-800 text-gray-400 text-[10px] font-mono mr-2 hover:text-white hover:border-gray-600 transition whitespace-nowrap';
                btn.innerText = '/' + name;
                btn.onclick = () => {
                    document.getElementById('cmdNameInput').value = name;
                    document.getElementById('cmdCodeInput').value = code;
                };
                list.appendChild(btn);
            });
            lucide.createIcons();
        }

        function newCmd() {
            document.getElementById('cmdNameInput').value = '';
            document.getElementById('cmdCodeInput').value = '';
        }

        async function saveCmd() {
            const name = document.getElementById('cmdNameInput').value;
            const code = document.getElementById('cmdCodeInput').value;
            if(!name) return showToast("COMMAND NAME REQUIRED", 'error');
            await fetch('/api/saveCommand', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ botId: currentBotId, command: name, code })
            });
            showToast("LOGIC WRITTEN TO DATABASE", 'success');
            openEditor(currentBotId);
        }

        async function deleteCmd() {
            const name = document.getElementById('cmdNameInput').value;
            if(name && confirm('Delete /'+name+'?')) {
                await fetch('/api/deleteCommand', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ botId: currentBotId, command: name })
                });
                openEditor(currentBotId);
            }
        }

        // üü¢ FIXED AI GENERATION FUNCTION üü¢
        function openAI(mode) { openModal('aiModal'); }

        async function generateAI() {
            const prompt = document.getElementById('aiPrompt').value;
            if(!prompt) return;
            
            closeModal('aiModal');
            const target = document.getElementById('cmdCodeInput');
            target.value = "// CONTACTING SERVER AI CORE...\n// GENERATING SECURE ASYNC CODE...";
            
            try {
                // Call local backend instead of external WebSocket
                const response = await fetch('/api/ai-generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt, type: 'code' })
                });

                const data = await response.json();

                if (data.success) {
                    target.value = data.result;
                    showToast("AI CODE GENERATED", 'success');
                } else {
                    target.value = "// ERROR: " + data.message;
                    showToast("GENERATION FAILED", 'error');
                }
            } catch (e) {
                target.value = "// CRITICAL NETWORK FAILURE";
                showToast("SERVER DISCONNECTED", 'error');
            }
        }

        // --- 7. PAYMENT ---
        function openPay(plan, price) {
            payDetails = { plan, price };
            document.getElementById('payPlan').innerText = plan;
            setPayMode('cash');
            openModal('payModal');
        }

        function setPayMode(mode) {
            payMode = mode;
            const cash = document.getElementById('cashSec');
            const ref = document.getElementById('refSec');
            if(mode === 'cash') {
                cash.classList.remove('hidden'); ref.classList.add('hidden');
                document.getElementById('tabCash').className = "flex-1 py-3 bg-dark-900 text-white text-[10px] font-bold font-mono transition shadow-inner";
                document.getElementById('tabRef').className = "flex-1 py-3 border border-transparent text-gray-500 text-[10px] font-bold font-mono hover:text-gray-300 transition";
            } else {
                ref.classList.remove('hidden'); cash.classList.add('hidden');
                document.getElementById('tabRef').className = "flex-1 py-3 bg-brand-blue text-white text-[10px] font-bold font-mono transition shadow-[0_0_10px_#3B82F6]";
                document.getElementById('tabCash').className = "flex-1 py-3 border border-transparent text-gray-500 text-[10px] font-bold font-mono hover:text-gray-300 transition";
            }
        }

        async function submitPay() {
            const trx = document.getElementById('trxId').value;
            if(payMode === 'cash' && !trx) return showToast("TRANSACTION ID MISSING", 'error');
            const res = await fetch('/api/submit-payment', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    userId: user.id.toString(), user: user.username,
                    method: payMode === 'cash' ? 'manual' : 'referral',
                    plan: payDetails.plan, amount: payDetails.price, trxId: trx
                })
            }).then(r => r.json());
            if(res.success) {
                closeModal('payModal');
                showToast("REQUEST TRANSMITTED", 'success');
                if(payMode === 'referral') init();
            } else {
                showToast(res.message, 'error');
            }
        }

        // --- 8. UTILS ---
        function copyToClipboard(txt) { navigator.clipboard.writeText(txt); showToast("COPIED TO CLIPBOARD", 'success'); }
        function copyLink() { copyToClipboard(`https://t.me/lagahostbot?start=${user.id}`); }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { 
            const el = document.getElementById(id);
            if(id === 'editorModal') el.classList.add('translate-x-full');
            setTimeout(() => el.classList.add('hidden'), 300);
        }

        window.onload = init;
    </script>
</body>
</html>
