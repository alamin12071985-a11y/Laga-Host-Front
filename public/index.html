<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Laga Host: Titanium Console</title>
    
    <!-- =========================================================================================== -->
    <!-- 1. CORE LIBRARIES & CDN DEPENDENCIES -->
    <!-- =========================================================================================== -->
    
    <!-- Telegram WebApp SDK (Required for Bot Interaction) -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Tailwind CSS (Utility Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons (Modern SVG Icons) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- PrismJS (Code Syntax Highlighting for Editor) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    
    <!-- Google Fonts (Inter & JetBrains Mono) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- =========================================================================================== -->
    <!-- 2. TAILWIND CONFIGURATION -->
    <!-- =========================================================================================== -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        // Custom Palette based on Travel App Reference
                        bgDark: '#0b1121',      // Deepest Blue
                        bgCard: '#151e32',      // Card Surface
                        primary: '#4f46e5',     // Indigo 600
                        primaryLight: '#818cf8',// Indigo 400
                        accent: '#ec4899',      // Pink 500
                        success: '#10b981',     // Emerald 500
                        warning: '#f59e0b',     // Amber 500
                        danger: '#ef4444',      // Red 500
                        textMain: '#f8fafc',    // Slate 50
                        textMuted: '#94a3b8',   // Slate 400
                        glassBorder: 'rgba(255, 255, 255, 0.08)'
                    },
                    boxShadow: {
                        'glow-primary': '0 0 20px rgba(79, 70, 229, 0.35)',
                        'glow-accent': '0 0 20px rgba(236, 72, 153, 0.35)',
                        'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.37)'
                    },
                    animation: {
                        'slide-up-fade': 'slideUpFade 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'scale-in': 'scaleIn 0.2s ease-out forwards',
                        'pulse-slow': 'pulse 4s infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'shimmer': 'shimmer 2s linear infinite',
                    },
                    keyframes: {
                        slideUpFade: {
                            '0%': { transform: 'translateY(40px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        scaleIn: {
                            '0%': { transform: 'scale(0.95)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' }
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '-1000px 0' },
                            '100%': { backgroundPosition: '1000px 0' }
                        }
                    }
                }
            }
        }
    </script>

    <!-- =========================================================================================== -->
    <!-- 3. ADVANCED CUSTOM CSS & GLASSMORPHISM -->
    <!-- =========================================================================================== -->
    <style>
        /* RESET & BASE */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: #0b1121;
            /* Dynamic Background Gradient */
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(79, 70, 229, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(236, 72, 153, 0.1) 0%, transparent 40%);
            background-attachment: fixed;
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            padding-bottom: 100px; /* Space for Bottom Nav */
        }

        /* --- GLASSMORPHISM SYSTEM --- */
        .glass-panel {
            background: rgba(21, 30, 50, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
        }

        .glass-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.8));
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* --- BOTTOM NAVIGATION (TRAVEL APP STYLE) --- */
        .nav-container {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 420px;
            height: 72px;
            border-radius: 24px;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 50px -10px rgba(0,0,0,0.6);
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            z-index: 900;
            padding: 0 10px;
        }

        .nav-btn {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 100%;
            color: #64748b;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-btn svg {
            width: 24px;
            height: 24px;
            transition: all 0.3s ease;
        }

        .nav-btn span {
            font-size: 10px;
            font-weight: 600;
            margin-top: 4px;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
        }

        /* Active State Animation */
        .nav-btn.active {
            color: #818cf8;
        }
        .nav-btn.active svg {
            transform: translateY(-4px);
            filter: drop-shadow(0 0 8px rgba(129, 140, 248, 0.5));
        }
        .nav-btn.active span {
            opacity: 1;
            transform: translateY(0);
        }

        /* --- BOT CARDS (POPULAR PLACES STYLE) --- */
        .bot-card-wrapper {
            position: relative;
            border-radius: 24px;
            overflow: hidden;
            transition: transform 0.2s;
            margin-bottom: 16px;
        }
        .bot-card-wrapper:active { transform: scale(0.98); }

        .bot-banner {
            height: 140px;
            width: 100%;
            background-size: cover;
            background-position: center;
            position: relative;
        }
        
        .bot-banner::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, rgba(15,23,42,0) 0%, rgba(15,23,42,0.8) 90%, #0f172a 100%);
        }

        .status-dot {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 4px 10px;
            border-radius: 20px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.1);
            font-size: 10px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
            text-transform: uppercase;
        }

        /* --- EDITOR UI --- */
        .editor-container {
            position: fixed;
            inset: 0;
            background: #0b1121;
            z-index: 2000;
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1);
            display: flex;
            flex-direction: column;
        }
        
        .editor-container.open { transform: translateX(0); }

        .editor-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: #94a3b8;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .editor-tab.active {
            color: #818cf8;
            border-bottom-color: #818cf8;
            background: rgba(129, 140, 248, 0.05);
        }

        .code-area {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            background: #080c17;
            color: #e2e8f0;
        }

        /* --- AI MODAL --- */
        .ai-modal-bg {
            position: fixed; inset: 0; z-index: 3000;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
        }
        .ai-modal-bg.visible { opacity: 1; pointer-events: auto; }
        
        .ai-panel {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: #151e32;
            border-top-left-radius: 32px;
            border-top-right-radius: 32px;
            padding: 32px;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .ai-modal-bg.visible .ai-panel { transform: translateY(0); }

        /* --- UTILS --- */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .skeleton {
            background: #1e293b;
            background-image: linear-gradient(to right, #1e293b 0%, #334155 20%, #1e293b 40%, #1e293b 100%);
            background-repeat: no-repeat;
            background-size: 1000px 100%;
            animation: shimmer 2s infinite linear forwards;
        }
    </style>
</head>
<body>

    <!-- =========================================================================================== -->
    <!-- 4. SYSTEM OVERLAYS (LOADERS, TOASTS) -->
    <!-- =========================================================================================== -->

    <!-- Initial Boot Screen -->
    <div id="bootScreen" class="fixed inset-0 z-[5000] bg-[#0b1121] flex flex-col items-center justify-center transition-opacity duration-700">
        <div class="relative">
            <div class="w-20 h-20 border-4 border-primary/20 rounded-full animate-spin-slow"></div>
            <div class="absolute inset-0 border-4 border-t-primary border-r-transparent border-b-transparent border-l-transparent rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <i data-lucide="cpu" class="w-8 h-8 text-primary animate-pulse"></i>
            </div>
        </div>
        <h1 class="mt-8 text-2xl font-bold text-white tracking-tighter">LAGA HOST</h1>
        <p class="text-xs text-primary font-mono tracking-[0.3em] uppercase mt-2">Titanium Edition</p>
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer" class="fixed top-6 left-1/2 -translate-x-1/2 z-[9000] w-[90%] max-w-sm pointer-events-none flex flex-col gap-2">
        <!-- Toasts injected here via JS -->
    </div>

    <!-- =========================================================================================== -->
    <!-- 5. MAIN APPLICATION VIEWS -->
    <!-- =========================================================================================== -->

    <!-- VIEW 1: HOME DASHBOARD -->
    <main id="view-home" class="view-section px-6 pt-8 pb-32 transition-all duration-500 opacity-100">
        
        <!-- Header Profile -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h2 class="text-2xl font-bold text-white">Dashboard</h2>
                <div class="flex items-center gap-2 mt-1">
                    <span class="relative flex h-2.5 w-2.5">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-success opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-success"></span>
                    </span>
                    <p class="text-xs text-textMuted font-medium" id="statusText">System Online</p>
                </div>
            </div>
            <div class="relative group" onclick="toggleProfile()">
                <div class="absolute -inset-0.5 bg-gradient-to-r from-primary to-accent rounded-full opacity-50 blur group-hover:opacity-100 transition"></div>
                <img id="userAvatar" src="" class="relative w-12 h-12 rounded-full border-2 border-[#0b1121] object-cover bg-gray-800">
            </div>
        </div>

        <!-- Search Bar (Glass) -->
        <div class="glass-panel rounded-2xl p-1.5 flex items-center gap-3 mb-8 relative focus-within:ring-2 ring-primary/50 transition">
            <div class="p-2.5 bg-white/5 rounded-xl text-gray-400">
                <i data-lucide="search" class="w-5 h-5"></i>
            </div>
            <input type="text" id="botSearch" class="bg-transparent w-full text-sm text-white focus:outline-none placeholder-gray-500 font-medium" placeholder="Find your bot...">
            <button class="p-2 text-gray-400 hover:text-white"><i data-lucide="sliders-horizontal" class="w-4 h-4"></i></button>
        </div>

        <!-- Quick Stats Carousel -->
        <div class="flex gap-4 mb-8 overflow-x-auto no-scrollbar pb-2">
            <!-- Stat 1 -->
            <div class="min-w-[140px] glass-card rounded-2xl p-4 flex flex-col justify-between h-[110px] relative overflow-hidden group">
                <div class="absolute -right-4 -top-4 w-16 h-16 bg-primary/20 rounded-full blur-xl group-hover:bg-primary/30 transition"></div>
                <div class="p-2 bg-primary/10 w-fit rounded-lg text-primary"><i data-lucide="server" class="w-5 h-5"></i></div>
                <div>
                    <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wide">Instances</p>
                    <p class="text-xl font-bold text-white" id="statRunning">0 / 0</p>
                </div>
            </div>
            <!-- Stat 2 -->
            <div class="min-w-[140px] glass-card rounded-2xl p-4 flex flex-col justify-between h-[110px] relative overflow-hidden group">
                <div class="absolute -right-4 -top-4 w-16 h-16 bg-accent/20 rounded-full blur-xl group-hover:bg-accent/30 transition"></div>
                <div class="p-2 bg-accent/10 w-fit rounded-lg text-accent"><i data-lucide="credit-card" class="w-5 h-5"></i></div>
                <div>
                    <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wide">Credits</p>
                    <p class="text-xl font-bold text-white" id="statPoints">0</p>
                </div>
            </div>
            <!-- Stat 3 (Action) -->
            <div onclick="openCreateModal()" class="min-w-[100px] bg-primary/10 border border-primary/20 border-dashed rounded-2xl flex flex-col items-center justify-center h-[110px] cursor-pointer hover:bg-primary/20 transition">
                <div class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center shadow-lg shadow-primary/30 mb-2">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                </div>
                <span class="text-[10px] font-bold text-primary">Deploy</span>
            </div>
        </div>

        <!-- Section Title -->
        <div class="flex items-center justify-between mb-5">
            <h3 class="text-lg font-bold text-white">Active Instances</h3>
            <button onclick="refreshData()" class="text-xs font-bold text-primary flex items-center gap-1 hover:text-white transition">
                <i data-lucide="refresh-cw" class="w-3 h-3"></i> Sync
            </button>
        </div>

        <!-- Bot List Container -->
        <div id="botList" class="space-y-6">
            <!-- Dynamic Injection Here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-16 opacity-50">
            <div class="w-24 h-24 bg-bgCard rounded-full flex items-center justify-center mb-6 border border-dashed border-gray-600">
                <i data-lucide="box-select" class="w-10 h-10 text-gray-500"></i>
            </div>
            <p class="text-sm font-bold text-white">No Instances Found</p>
            <p class="text-xs text-textMuted mt-1 text-center max-w-[200px]">Your server rack is empty. Deploy a new bot to get started.</p>
        </div>

    </main>

    <!-- VIEW 2: DISCOVER / MARKETPLACE (Placeholder) -->
    <main id="view-discover" class="view-section hidden px-6 pt-8 pb-32">
        <h2 class="text-2xl font-bold text-white mb-6">Marketplace</h2>
        <div class="glass-card rounded-2xl p-8 text-center border-dashed border border-gray-700">
            <div class="w-16 h-16 bg-gradient-to-tr from-primary to-purple-500 rounded-2xl mx-auto flex items-center justify-center shadow-lg mb-4">
                <i data-lucide="shopping-bag" class="w-8 h-8 text-white"></i>
            </div>
            <h3 class="text-lg font-bold text-white">Coming Soon</h3>
            <p class="text-sm text-gray-400 mt-2">Download pre-built bot templates, plugins, and AI models directly to your instance.</p>
        </div>
    </main>

    <!-- VIEW 3: SETTINGS -->
    <main id="view-settings" class="view-section hidden px-6 pt-8 pb-32">
        <h2 class="text-2xl font-bold text-white mb-6">Configuration</h2>
        
        <!-- User Info Card -->
        <div class="glass-panel rounded-2xl p-5 flex items-center gap-4 mb-6">
            <img id="settingsAvatar" src="" class="w-16 h-16 rounded-full bg-gray-700">
            <div>
                <h3 class="font-bold text-white text-lg" id="settingsName">User</h3>
                <p class="text-xs text-primary font-mono bg-primary/10 px-2 py-0.5 rounded w-fit mt-1" id="settingsPlan">FREE TIER</p>
            </div>
        </div>

        <!-- Options -->
        <div class="space-y-3">
            <button class="w-full glass-card p-4 rounded-xl flex items-center justify-between group hover:bg-white/5 transition">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-blue-500/10 rounded-lg text-blue-500"><i data-lucide="bell" class="w-5 h-5"></i></div>
                    <span class="text-sm font-medium">Notifications</span>
                </div>
                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-500 group-hover:text-white"></i>
            </button>

            <button class="w-full glass-card p-4 rounded-xl flex items-center justify-between group hover:bg-white/5 transition">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-purple-500/10 rounded-lg text-purple-500"><i data-lucide="shield-check" class="w-5 h-5"></i></div>
                    <span class="text-sm font-medium">Privacy & Security</span>
                </div>
                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-500 group-hover:text-white"></i>
            </button>

            <button onclick="Telegram.WebApp.openLink('https://t.me/lagatech')" class="w-full glass-card p-4 rounded-xl flex items-center justify-between group hover:bg-white/5 transition">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-green-500/10 rounded-lg text-green-500"><i data-lucide="headphones" class="w-5 h-5"></i></div>
                    <span class="text-sm font-medium">Support Center</span>
                </div>
                <i data-lucide="external-link" class="w-4 h-4 text-gray-500 group-hover:text-white"></i>
            </button>
        </div>
    </main>

    <!-- =========================================================================================== -->
    <!-- 6. FLOATING BOTTOM NAVIGATION -->
    <!-- =========================================================================================== -->
    <nav class="nav-container">
        <button class="nav-btn active" onclick="switchTab('home', this)">
            <i data-lucide="layout-grid"></i>
            <span>Home</span>
        </button>
        <button class="nav-btn" onclick="switchTab('discover', this)">
            <i data-lucide="compass"></i>
            <span>Store</span>
        </button>
        <button class="nav-btn" onclick="switchTab('settings', this)">
            <i data-lucide="sliders"></i>
            <span>Config</span>
        </button>
    </nav>

    <!-- =========================================================================================== -->
    <!-- 7. MODALS & OVERLAYS (THE INTERACTION LAYER) -->
    <!-- =========================================================================================== -->

    <!-- [A] CREATE BOT MODAL -->
    <div id="createModal" class="fixed inset-0 z-[2000] hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity opacity-0" id="createBackdrop" onclick="closeModal('createModal')"></div>
        <div class="absolute bottom-0 w-full md:w-[480px] md:left-1/2 md:-translate-x-1/2 bg-[#151e32] rounded-t-3xl border-t border-glassBorder p-8 shadow-2xl transform translate-y-full transition-transform duration-300" id="createPanel">
            
            <div class="w-12 h-1.5 bg-gray-700 rounded-full mx-auto mb-8"></div>
            
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-primary/10 rounded-2xl flex items-center justify-center mx-auto mb-4 border border-primary/20 shadow-glow-primary">
                    <i data-lucide="bot" class="w-8 h-8 text-primary"></i>
                </div>
                <h2 class="text-2xl font-bold text-white">Deploy New Bot</h2>
                <p class="text-sm text-textMuted mt-1">Host your Node.js bot instance in seconds.</p>
            </div>

            <div class="space-y-5">
                <div class="group">
                    <label class="text-xs font-bold text-primary uppercase tracking-wider mb-2 block ml-1">Bot Name</label>
                    <input id="newBotName" type="text" class="w-full bg-[#0b1121] border border-gray-700 rounded-xl p-4 text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none transition" placeholder="e.g. Super Assistant">
                </div>
                <div class="group">
                    <label class="text-xs font-bold text-primary uppercase tracking-wider mb-2 block ml-1">Bot Token</label>
                    <div class="relative">
                        <input id="newBotToken" type="text" class="w-full bg-[#0b1121] border border-gray-700 rounded-xl p-4 pr-12 text-white font-mono text-sm focus:border-primary focus:ring-1 focus:ring-primary outline-none transition" placeholder="123456:ABC-DEF...">
                        <div class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500"><i data-lucide="key" class="w-4 h-4"></i></div>
                    </div>
                    <p class="text-[10px] text-gray-500 mt-2 ml-1">Get this from <a href="#" class="text-primary hover:underline">@BotFather</a> on Telegram.</p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mt-8">
                <button onclick="closeModal('createModal')" class="py-4 rounded-xl border border-gray-600 text-gray-300 font-bold text-sm hover:bg-gray-800 transition">Cancel</button>
                <button onclick="submitCreateBot()" class="py-4 rounded-xl bg-primary text-white font-bold text-sm shadow-lg shadow-primary/30 hover:bg-primaryLight transition flex items-center justify-center gap-2">
                    <span id="createBtnText">Deploy Instance</span>
                    <i data-lucide="rocket" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- [B] THE ULTIMATE CODE EDITOR -->
    <div id="editorPanel" class="editor-container">
        
        <!-- Editor Header -->
        <div class="h-16 border-b border-white/5 flex items-center justify-between px-4 bg-[#0f172a] shadow-lg z-20">
            <button onclick="closeEditor()" class="p-2 text-gray-400 hover:text-white bg-white/5 rounded-lg transition">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
            </button>
            
            <div class="flex flex-col items-center">
                <span class="text-sm font-bold text-white tracking-wide">LOGIC STUDIO</span>
                <span class="text-[10px] text-primary font-mono" id="editorBotName">bot_instance</span>
            </div>

            <button onclick="saveLogic()" class="bg-success text-white px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-2 shadow-lg shadow-success/20 hover:bg-emerald-400 transition">
                <i data-lucide="save" class="w-3.5 h-3.5"></i> SAVE
            </button>
        </div>

        <!-- Mode Switcher (The 3 Tabs Request) -->
        <div class="px-4 py-3 bg-[#0f172a] border-b border-white/5 shadow-md z-10">
            <div class="flex bg-[#0b1121] p-1 rounded-xl border border-white/5">
                <button onclick="setMode('command')" id="tab-command" class="editor-tab active">
                    <i data-lucide="terminal" class="w-3 h-3 mx-auto mb-1"></i>
                    Command
                </button>
                <button onclick="setMode('menu')" id="tab-menu" class="editor-tab">
                    <i data-lucide="layout-grid" class="w-3 h-3 mx-auto mb-1"></i>
                    Main Menu
                </button>
                <button onclick="setMode('keyboard')" id="tab-keyboard" class="editor-tab">
                    <i data-lucide="mouse-pointer-2" class="w-3 h-3 mx-auto mb-1"></i>
                    Keyboard
                </button>
            </div>
        </div>

        <!-- Trigger Input Area -->
        <div class="px-4 py-4 bg-[#0f172a] border-b border-white/5 z-10">
            <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-2 block" id="triggerLabel">Command Trigger</label>
            <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <span id="triggerPrefix" class="text-primary font-mono font-bold text-lg">/</span>
                </div>
                <input id="cmdTrigger" type="text" class="block w-full pl-8 pr-10 py-3 bg-[#1e293b] border border-white/10 rounded-xl text-sm font-mono text-white placeholder-gray-600 focus:outline-none focus:border-primary transition" placeholder="start">
                <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                    <i data-lucide="zap" class="w-4 h-4 text-accent animate-pulse"></i>
                </div>
            </div>
        </div>

        <!-- Code Area -->
        <div class="flex-1 relative bg-[#080c17]">
            <!-- Line Numbers (Visual Only for feel) -->
            <div class="absolute left-0 top-0 bottom-0 w-8 bg-[#0b1121] border-r border-white/5 flex flex-col items-center pt-4 text-[10px] text-gray-700 font-mono select-none">
                <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span>
            </div>
            
            <textarea id="codeEditor" class="w-full h-full bg-transparent text-gray-300 font-mono text-xs pl-12 pr-4 py-4 resize-none focus:outline-none leading-6" spellcheck="false" placeholder="// Select a mode above, enter a trigger, and use the AI Wand to generate code..."></textarea>
            
            <!-- AI Floating Action Button -->
            <button onclick="openAI()" class="absolute bottom-6 right-6 w-14 h-14 bg-gradient-to-tr from-primary to-accent rounded-full flex items-center justify-center shadow-glow-accent hover:scale-110 transition active:scale-95 z-40 animate-float">
                <i data-lucide="sparkles" class="w-6 h-6 text-white"></i>
            </button>
        </div>
    </div>

    <!-- [C] AI ARCHITECT MODAL (CONTEXT AWARE) -->
    <div id="aiModal" class="ai-modal-bg">
        <div class="ai-panel">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        <i data-lucide="bot" class="text-accent"></i>
                        AI Architect
                    </h3>
                    <p class="text-xs text-textMuted mt-1">Generating logic for: <span id="aiContextLabel" class="text-primary font-bold uppercase">COMMAND</span></p>
                </div>
                <button onclick="closeAI()" class="p-2 bg-white/5 rounded-full text-gray-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="bg-[#0b1121] p-4 rounded-2xl border border-white/10 mb-6 relative">
                <textarea id="aiPrompt" class="w-full h-24 bg-transparent text-sm text-white resize-none focus:outline-none placeholder-gray-600" placeholder="Describe what you want... e.g., 'Send a welcome photo with 2 buttons for Support and Channel'"></textarea>
                <div class="absolute bottom-3 right-3 text-[10px] text-gray-600">Powered by LagaAI</div>
            </div>
            
            <button onclick="generateCode()" class="w-full py-4 bg-white text-black font-bold rounded-xl hover:bg-gray-200 transition flex items-center justify-center gap-2" id="aiGenBtn">
                <i data-lucide="wand-2" class="w-4 h-4"></i>
                <span>Generate Code</span>
            </button>
        </div>
    </div>

    <!-- =========================================================================================== -->
    <!-- 8. JAVASCRIPT LOGIC ENGINE -->
    <!-- =========================================================================================== -->
    <script>
        // -------------------------------------------------------------------------
        // 1. INITIALIZATION & STATE
        // -------------------------------------------------------------------------
        
        // Initialize Lucide Icons
        lucide.createIcons();

        // Telegram WebApp Setup
        const tg = window.Telegram.WebApp;
        tg.expand(); // Full Screen
        tg.enableClosingConfirmation();
        tg.setHeaderColor('#0b1121');
        tg.setBackgroundColor('#0b1121');

        // State Objects
        const AppState = {
            user: tg.initDataUnsafe?.user || { id: '7605281774', first_name: 'Developer', username: 'dev' },
            activeBotId: null,
            editorMode: 'command', // 'command' | 'menu' | 'keyboard'
            bots: []
        };

        // DOM Elements (Cached)
        const els = {
            bootScreen: document.getElementById('bootScreen'),
            app: document.getElementById('view-home'),
            botList: document.getElementById('botList'),
            emptyState: document.getElementById('emptyState'),
            userAvatar: document.getElementById('userAvatar'),
            stats: {
                running: document.getElementById('statRunning'),
                points: document.getElementById('statPoints')
            }
        };

        // -------------------------------------------------------------------------
        // 2. LIFECYCLE METHODS
        // -------------------------------------------------------------------------

        // Start App
        async function init() {
            console.log("System Booting...");
            
            // Set User Data
            els.userAvatar.src = AppState.user.photo_url || `https://ui-avatars.com/api/?name=${AppState.user.first_name}&background=4f46e5&color=fff&bold=true`;
            document.getElementById('settingsAvatar').src = els.userAvatar.src;
            document.getElementById('settingsName').innerText = AppState.user.first_name;

            // Fetch Data
            await refreshData();

            // Hide Loader
            setTimeout(() => {
                els.bootScreen.classList.add('opacity-0', 'pointer-events-none');
            }, 800);
        }

        // Fetch Bots from Backend
        async function refreshData() {
            try {
                // Show skeleton loading state if list is empty
                if(AppState.bots.length === 0) {
                    els.botList.innerHTML = Array(3).fill(0).map(() => 
                        `<div class="w-full h-32 rounded-2xl skeleton mb-4"></div>`
                    ).join('');
                }

                const res = await fetch('/api/bots', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: AppState.user.id.toString(),
                        username: AppState.user.username,
                        firstName: AppState.user.first_name
                    })
                });

                const data = await res.json();
                
                if(data.success) {
                    AppState.bots = data.bots;
                    updateUI(data);
                } else {
                    showToast(data.message || "Failed to sync", "error");
                }
            } catch (e) {
                console.error(e);
                showToast("Connection Error", "error");
            }
        }

        // -------------------------------------------------------------------------
        // 3. UI RENDERING ENGINE
        // -------------------------------------------------------------------------

        function updateUI(data) {
            const user = data.user;
            const bots = data.bots;

            // Update Stats
            els.stats.points.innerText = user.referrals;
            const runningCount = bots.filter(b => b.status === 'RUNNING').length;
            els.stats.running.innerText = `${runningCount} / ${bots.length}`;
            document.getElementById('settingsPlan').innerText = user.plan + " PLAN";

            // Render Bot List
            els.botList.innerHTML = '';

            if (bots.length === 0) {
                els.emptyState.classList.remove('hidden');
                return;
            } else {
                els.emptyState.classList.add('hidden');
            }

            bots.forEach(bot => {
                const isRun = bot.status === 'RUNNING';
                // Travel App "Popular Place" Style Card
                const card = document.createElement('div');
                card.className = 'bot-card-wrapper glass-panel';
                
                // Dynamic Hue for visuals
                const hue = (bot.token.length * 5) % 360;

                card.innerHTML = `
                    <div class="bot-banner" style="background-image: url('https://grainy-gradients.vercel.app/noise.svg'); background-color: hsl(${hue}, 60%, 20%);">
                        <div class="status-dot ${isRun ? 'text-success border-success/30' : 'text-gray-400 border-gray-500/30'}">
                            <span class="w-2 h-2 rounded-full ${isRun ? 'bg-success animate-pulse' : 'bg-gray-400'}"></span>
                            ${bot.status}
                        </div>
                        
                        <div class="absolute bottom-4 left-4 z-10">
                            <h3 class="text-white font-bold text-lg drop-shadow-md">${bot.name}</h3>
                            <p class="text-xs text-gray-300 font-mono opacity-80">${bot.token.substring(0, 12)}...</p>
                        </div>

                        <button onclick="openEditor('${bot._id}', '${bot.name}')" class="absolute bottom-4 right-4 z-10 bg-white text-black p-2 rounded-xl shadow-lg hover:scale-105 transition active:scale-95">
                            <i data-lucide="edit-3" class="w-4 h-4"></i>
                        </button>
                    </div>

                    <div class="p-4 grid grid-cols-2 gap-3">
                         ${isRun ? `
                            <button onclick="toggleBot('${bot._id}', 'stop')" class="py-3 rounded-xl bg-danger/10 text-danger font-bold text-xs hover:bg-danger/20 transition flex items-center justify-center gap-2">
                                <i data-lucide="square" class="w-3 h-3 fill-current"></i> STOP
                            </button>
                            <button onclick="restartBot('${bot._id}')" class="py-3 rounded-xl bg-primary/10 text-primary font-bold text-xs hover:bg-primary/20 transition flex items-center justify-center gap-2">
                                <i data-lucide="refresh-cw" class="w-3 h-3"></i> REBOOT
                            </button>
                         ` : `
                            <button onclick="toggleBot('${bot._id}', 'start')" class="col-span-2 py-3 rounded-xl bg-success text-white font-bold text-xs shadow-glow-primary hover:bg-emerald-400 transition flex items-center justify-center gap-2">
                                <i data-lucide="power" class="w-4 h-4"></i>
                                START SERVER
                            </button>
                         `}
                    </div>
                    
                    ${!isRun ? `
                    <div class="px-4 pb-4">
                        <button onclick="deleteBot('${bot._id}')" class="w-full py-2 text-[10px] text-gray-500 hover:text-danger hover:bg-danger/5 rounded-lg transition border border-dashed border-gray-700">
                            DELETE PERMANENTLY
                        </button>
                    </div>` : ''}
                `;
                els.botList.appendChild(card);
            });
            lucide.createIcons();
        }

        // -------------------------------------------------------------------------
        // 4. EDITOR LOGIC (THE CORE REQUEST)
        // -------------------------------------------------------------------------

        async function openEditor(botId, botName) {
            AppState.activeBotId = botId;
            document.getElementById('editorBotName').innerText = botName;
            
            // Reset to Command Mode
            setMode('command');
            
            // Show Panel
            document.getElementById('editorPanel').classList.add('open');
        }

        function closeEditor() {
            document.getElementById('editorPanel').classList.remove('open');
        }

        function setMode(mode) {
            AppState.editorMode = mode;
            
            // 1. Update Tabs
            document.querySelectorAll('.editor-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${mode}`).classList.add('active');

            // 2. Update Input UI
            const prefix = document.getElementById('triggerPrefix');
            const input = document.getElementById('cmdTrigger');
            const label = document.getElementById('triggerLabel');

            if (mode === 'command') {
                label.innerText = "Telegram Command";
                prefix.innerText = '/';
                input.placeholder = 'start';
            } else if (mode === 'menu') {
                label.innerText = "Button Text Match";
                prefix.innerText = 'TXT';
                prefix.style.fontSize = '12px';
                input.placeholder = 'Support ðŸ“ž';
            } else if (mode === 'keyboard') {
                label.innerText = "Callback Data";
                prefix.innerText = 'CB';
                prefix.style.fontSize = '12px';
                input.placeholder = 'btn_action_1';
            }

            // 3. Clear Code Area (Optional: Could fetch previous code here)
            document.getElementById('codeEditor').value = '';
            document.getElementById('codeEditor').placeholder = `// Enter ${mode} logic here or use AI...`;
        }

        async function saveLogic() {
            const trigger = document.getElementById('cmdTrigger').value;
            const code = document.getElementById('codeEditor').value;

            if(!trigger || !code) return showToast("Missing Fields", "error");

            // Format Trigger based on mode
            let finalKey = trigger;
            if(AppState.editorMode === 'command' && !trigger.startsWith('/')) {
                finalKey = '/' + trigger;
            }
            // For Menu/Keyboard, backend handles plain keys

            try {
                await fetch('/api/saveCommand', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        botId: AppState.activeBotId,
                        command: finalKey,
                        code: code
                    })
                });
                showToast("Logic Saved Successfully", "success");
            } catch(e) {
                showToast("Save Failed", "error");
            }
        }

        // -------------------------------------------------------------------------
        // 5. AI GENERATION LOGIC (CONTEXT AWARE)
        // -------------------------------------------------------------------------

        function openAI() {
            const modeMap = { 'command': 'COMMAND', 'menu': 'MAIN MENU', 'keyboard': 'INLINE BTN' };
            document.getElementById('aiContextLabel').innerText = modeMap[AppState.editorMode];
            
            document.getElementById('aiModal').classList.add('visible');
            document.getElementById('aiPrompt').focus();
        }

        function closeAI() {
            document.getElementById('aiModal').classList.remove('visible');
        }

        function generateCode() {
            const prompt = document.getElementById('aiPrompt').value;
            const btn = document.getElementById('aiGenBtn');
            
            if(!prompt) return;

            // UI Feedback
            const originalBtn = btn.innerHTML;
            btn.innerHTML = `<i class="animate-spin" data-lucide="loader"></i> Generating...`;

            // --- SYSTEM PROMPT ENGINEERING ---
            let sysPrompt = "";
            
            if (AppState.editorMode === 'command') {
                sysPrompt = `
                    TASK: Generate Telegraf.js v4 code for a Command.
                    USER REQUEST: "${prompt}"
                    RULES:
                    1. Use 'ctx.reply' or 'ctx.replyWithPhoto'.
                    2. NO markdown wrapping (\`\`\`). Raw JS only.
                    3. Do not wrap in 'bot.command', just the function body.
                    EXAMPLE:
                    ctx.reply('Hello World', Markup.inlineKeyboard([
                        [Markup.button.url('Link', 'https://google.com')]
                    ]));
                `;
            } else if (AppState.editorMode === 'menu') {
                sysPrompt = `
                    TASK: Generate Telegraf.js v4 code for a Persistent Menu (ReplyKeyboard).
                    USER REQUEST: "${prompt}"
                    RULES:
                    1. MUST use 'Markup.keyboard([...]).resize()'.
                    2. NO markdown. Raw JS only.
                    EXAMPLE:
                    ctx.reply('Select Option:', Markup.keyboard([
                        ['ðŸ’° Balance', 'ðŸ‘¤ Profile'],
                        ['ðŸ“ž Support']
                    ]).resize());
                `;
            } else if (AppState.editorMode === 'keyboard') {
                sysPrompt = `
                    TASK: Generate Telegraf.js v4 code for an Inline Keyboard callback response.
                    USER REQUEST: "${prompt}"
                    RULES:
                    1. MUST use 'Markup.inlineKeyboard([...])'.
                    2. Use 'ctx.editMessageText' or 'ctx.reply'.
                    3. NO markdown. Raw JS only.
                    EXAMPLE:
                    ctx.reply('Details here:', Markup.inlineKeyboard([
                        [Markup.button.callback('Back', 'go_back')]
                    ]));
                `;
            }

            // WebSocket Connection
            const ws = new WebSocket("wss://backend.buildpicoapps.com/ask_ai_streaming_v2");
            
            ws.onopen = () => {
                ws.send(JSON.stringify({
                    appId: "truth-choose",
                    prompt: sysPrompt
                }));
            };

            let buffer = "";
            ws.onmessage = (event) => {
                buffer += event.data;
                // Real-time cleanup
                const cleanCode = buffer.replace(/```javascript/g, '').replace(/```/g, '').trim();
                document.getElementById('codeEditor').value = cleanCode;
            };

            ws.onclose = () => {
                closeAI();
                btn.innerHTML = originalBtn;
                showToast("Code Generated via AI", "success");
            };
            
            ws.onerror = () => {
                showToast("AI Service Error", "error");
                btn.innerHTML = originalBtn;
            };
        }

        // -------------------------------------------------------------------------
        // 6. ACTION HANDLERS (CREATE, TOGGLE, DELETE)
        // -------------------------------------------------------------------------

        async function submitCreateBot() {
            const name = document.getElementById('newBotName').value;
            const token = document.getElementById('newBotToken').value;
            const btn = document.querySelector('#createPanel button:last-child');

            if(!name || !token) return showToast("All fields required", "error");

            btn.innerHTML = `<i class="animate-spin" data-lucide="loader"></i> Deploying...`;

            try {
                const res = await fetch('/api/createBot', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name, token, userId: AppState.user.id.toString() })
                });
                const data = await res.json();
                
                if(data.success) {
                    closeModal('createModal');
                    showToast("Bot Deployed Successfully", "success");
                    refreshData();
                } else {
                    showToast(data.message, "error");
                }
            } catch(e) { showToast("Network Error", "error"); }
            
            btn.innerHTML = `<span>Deploy Instance</span><i data-lucide="rocket" class="w-4 h-4"></i>`;
            lucide.createIcons();
        }

        async function toggleBot(id, action) {
            showToast(action === 'start' ? "Booting System..." : "Halting Process...", "info");
            await fetch('/api/toggleBot', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ botId: id, action })
            });
            setTimeout(refreshData, 1500);
        }

        async function restartBot(id) {
            showToast("Rebooting Instance...", "info");
            await fetch('/api/restartBot', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ botId: id })
            });
            setTimeout(refreshData, 2000);
        }

        function deleteBot(id) {
            tg.showConfirm("Danger: Permanently delete this bot and all its data?", (ok) => {
                if(ok) {
                    fetch('/api/deleteBot', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ botId: id })
                    }).then(() => {
                        showToast("Instance Destroyed", "success");
                        refreshData();
                    });
                }
            });
        }

        // -------------------------------------------------------------------------
        // 7. UTILITIES
        // -------------------------------------------------------------------------

        function showToast(msg, type) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            
            // Icon selection
            let icon = type === 'error' ? 'alert-triangle' : (type === 'success' ? 'check-circle' : 'info');
            let color = type === 'error' ? 'text-red-400' : (type === 'success' ? 'text-green-400' : 'text-blue-400');
            let border = type === 'error' ? 'border-red-500/20' : 'border-green-500/20';

            toast.className = `glass-panel p-4 rounded-xl flex items-center gap-3 border ${border} shadow-xl animate-scale-in`;
            toast.innerHTML = `
                <i data-lucide="${icon}" class="${color} w-5 h-5"></i>
                <span class="text-sm font-medium text-white">${msg}</span>
            `;
            
            container.appendChild(toast);
            lucide.createIcons();

            // Auto remove
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-20px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function switchTab(viewName, btn) {
            // Hide all sections
            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.add('hidden');
                el.classList.remove('animate-slide-up-fade');
            });
            
            // Show selected
            const target = document.getElementById(`view-${viewName}`);
            target.classList.remove('hidden');
            target.classList.add('animate-slide-up-fade');

            // Update Nav
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
        }

        // Modal Logic
        function openModal(id) {
            const modal = document.getElementById(id);
            const backdrop = modal.querySelector('div:first-child');
            const panel = modal.querySelector('div:last-child');
            
            modal.classList.remove('hidden');
            // Allow reflow
            void modal.offsetWidth;
            
            backdrop.classList.remove('opacity-0');
            panel.classList.remove('translate-y-full');
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            const backdrop = modal.querySelector('div:first-child');
            const panel = modal.querySelector('div:last-child');

            backdrop.classList.add('opacity-0');
            panel.classList.add('translate-y-full');

            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function openCreateModal() { openModal('createModal'); }

        // Start App
        window.onload = init;

    </script>
</body>
</html>
